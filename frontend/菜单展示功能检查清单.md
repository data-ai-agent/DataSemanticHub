# 菜单展示功能检查清单

## 已完成的功能

### 1. 菜单加载机制 ✅

**位置**: `frontend/src/App.tsx`

- ✅ 从 API 加载菜单：`menuService.getMenuTree()`
- ✅ 缓存机制：5分钟 TTL，存储在 localStorage
- ✅ 降级方案：API 失败时使用静态配置
- ✅ 产品过滤：根据 `activeProduct` 过滤菜单
- ✅ 菜单转换：使用 `transformMenuTreeToMenuGroups` 转换格式

### 2. 菜单刷新机制 ✅

**位置**: `frontend/src/App.tsx` 和 `frontend/src/views/MenuManagementView.tsx`

- ✅ 事件监听：监听 `menus-updated` 事件自动刷新
- ✅ 缓存清除：所有菜单修改操作后清除缓存
- ✅ 触发刷新：修改菜单后触发全局事件

**已添加刷新触发的位置**:
- ✅ 创建菜单 (`createMenu`)
- ✅ 更新菜单 (`updateMenu`)
- ✅ 删除菜单 (`deleteMenu`)
- ✅ 移动菜单 (`moveMenu`)
- ✅ 排序菜单 (`reorderMenus`)
- ✅ 切换可见性 (`toggleMenuVisible`)

### 3. 图标显示 ✅

**位置**: `frontend/src/services/menuTransformService.ts`

- ✅ 优先使用菜单中存储的 `icon` 字段
- ✅ 使用 `getIconByName` 工具函数解析图标组件
- ✅ 降级方案：如果图标不存在，使用自动查找逻辑

### 4. 菜单顺序 ✅

**位置**: `frontend/src/services/menuTransformService.ts`

- ✅ 按 `order` 字段排序同级菜单
- ✅ 保持树形结构的层级关系

---

## 检查步骤

### 步骤 1: 验证菜单是否从 API 加载

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 查找请求：`GET /api/v1/system/menus/tree?enabled=true&visible=true`
5. 确认请求成功（状态码 200）

**如果请求失败**:
- 检查后端服务是否运行
- 检查 API 地址配置
- 查看控制台错误信息

### 步骤 2: 验证菜单缓存

1. 打开浏览器开发者工具（F12）
2. 切换到 Application/Storage 标签
3. 查看 Local Storage
4. 查找键：`sidebar_menus_cache_governance` 或 `sidebar_menus_cache_agent_factory`
5. 确认缓存数据存在且包含菜单信息

**清除缓存**:
```javascript
// 在浏览器控制台执行
localStorage.removeItem('sidebar_menus_cache_governance');
localStorage.removeItem('sidebar_menus_cache_agent_factory');
```

### 步骤 3: 验证菜单移动后刷新

1. 打开菜单管理页面
2. 拖拽移动一个菜单
3. 观察侧边栏是否立即更新
4. 检查控制台是否有 "收到菜单更新事件，刷新菜单..." 日志

**如果未刷新**:
- 检查控制台是否有错误
- 确认 `menus-updated` 事件是否触发
- 检查 `loadMenus` 函数是否被调用

### 步骤 4: 验证图标显示

1. 在菜单管理中为菜单设置图标
2. 保存菜单
3. 检查侧边栏是否显示正确的图标

**如果图标未显示**:
- 检查菜单数据中是否包含 `icon` 字段
- 检查 `getIconByName` 函数是否能正确解析图标名称
- 查看控制台是否有图标相关的警告或错误

### 步骤 5: 验证菜单顺序

1. 在菜单管理中调整菜单顺序（拖拽）
2. 保存后检查侧边栏菜单顺序是否更新

**如果顺序未更新**:
- 检查后端返回的菜单数据中 `order` 字段是否正确
- 检查 `transformMenuTreeToMenuGroups` 是否正确排序

---

## 调试工具

### 浏览器控制台命令

```javascript
// 查看当前菜单缓存
JSON.parse(localStorage.getItem('sidebar_menus_cache_governance'))

// 清除所有菜单缓存
Object.keys(localStorage).filter(k => k.startsWith('sidebar_menus_cache_')).forEach(k => localStorage.removeItem(k))

// 手动触发菜单刷新事件
window.dispatchEvent(new CustomEvent('menus-updated'))

// 查看菜单 API 响应
fetch('/api/v1/system/menus/tree?enabled=true&visible=true')
  .then(r => r.json())
  .then(console.log)
```

### 检查菜单数据

在 `App.tsx` 的 `loadMenus` 函数中添加日志：

```typescript
console.log('加载的菜单数据:', transformedMenus);
console.log('菜单来源:', useStaticMenus ? '静态配置' : 'API');
```

---

## 常见问题

### 问题 1: 菜单未从 API 加载

**症状**: 侧边栏显示静态菜单，而不是后端数据

**可能原因**:
1. API 请求失败，降级到静态配置
2. 缓存中有旧数据
3. `useStaticMenus` 状态为 `true`

**解决方法**:
1. 检查 Network 标签中的 API 请求
2. 清除菜单缓存
3. 刷新页面

### 问题 2: 移动菜单后侧边栏未更新

**症状**: 在菜单管理中移动菜单后，侧边栏没有变化

**可能原因**:
1. 缓存未清除
2. 事件未触发
3. `loadMenus` 函数未执行

**解决方法**:
1. 检查控制台是否有 "收到菜单更新事件" 日志
2. 手动清除缓存并刷新
3. 检查 `menus-updated` 事件监听器是否正确注册

### 问题 3: 图标未显示

**症状**: 侧边栏菜单没有图标或显示默认图标

**可能原因**:
1. 菜单数据中没有 `icon` 字段
2. 图标名称无法解析
3. 图标组件导入错误

**解决方法**:
1. 检查菜单数据中的 `icon` 字段
2. 确认图标名称在 `iconUtils.ts` 的 `ICON_NAME_MAP` 中
3. 查看控制台是否有图标相关的错误

---

## 验证清单

- [ ] 菜单从 API 成功加载
- [ ] 菜单缓存正常工作
- [ ] 移动菜单后侧边栏立即刷新
- [ ] 图标正确显示
- [ ] 菜单顺序正确
- [ ] 菜单层级结构正确
- [ ] 产品切换时菜单正确更新

---

**最后更新**: 2026-01-26
