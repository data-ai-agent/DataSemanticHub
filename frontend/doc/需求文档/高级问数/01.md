以下为可直接用于工程协作与大模型代码生成的文档格式，覆盖 **前端 Frame 结构 + 后端接口契约 + Trace 状态机 + 错误码规范**（面向你们“数据语义治理平台 / DataSemanticHub”的问数模块）。

---

# 智能问数（Q&A）工程文档 v1.0

## 0. 目标与范围

**目标**：将“聊天问数”升级为“可解释、可审计、可复现”的分析工作台，杜绝“Failed to fetch”不可诊断失败；每次回答必须产出结构化 **Reasoning Trace**，支撑：

* 业务用户：口径可信、来源透明、权限提示清晰
* 分析师：SQL可复制、计划可复现、可钻取
* 管理员/开发：可诊断（请求ID、阶段、错误码、重试链路）

**范围（本期必须交付）**

* 前端：问数主页面 + Trace 抽屉 + 错误卡 + 场景示例
* 后端：Ask 任务接口（支持分阶段回传）+ Trace 落库查询
* Trace：6阶段状态机（parse/ground/plan/generate/execute/explain）
* 错误码：分层（HTTP + 业务码）+ 可恢复策略

---

# 1. 前端 Frame 结构（Figma Frame 级信息架构）

## 1.1 页面：数据服务 > 问数（QnAWorkbenchPage）

**Frame: `QnAWorkbenchPage`**

* `TopBar`

  * 面包屑：数据服务 / 问数
  * 页面标题：智能问数
  * 右侧按钮：`调试工具`（管理员可见）/ `帮助`
* `ContextBar`（固定在顶部，P0）

  * `DomainSelector` 数据域（销售/供应链/库存…）
  * `SemanticVersionSelector` 语义版本（vX.Y，可切换）
  * `TimeRangePicker` 默认时间范围（近7天/30天/自定义）
  * `SecurityScopeIndicator` 权限范围（只读提示：已按角色裁剪/已聚合/已脱敏）
  * `QualityBadge`（可选）：数据新鲜度/质量状态概览（绿/黄/红）
* 主体左右分栏 `MainLayout`

  * 左：`ChatPanel`
  * 右：`SidePanel`（场景示例/最近查询/收藏）

---

## 1.2 左侧：ChatPanel（对话与分析卡片）

**Frame: `ChatPanel`**

* `ConversationHeader`

  * 引导文案 + 示例问题（可点击填充输入框，不自动执行）
* `MessageList`（虚拟滚动）

  * `UserMessageBubble`
  * `AssistantAnswerCard`（替代纯气泡，承载分析结果）
  * `SystemErrorCard`（失败时替代“Failed to fetch”）
* `Composer`（输入区）

  * 输入框（支持 @ 指标、# 维度、/ 时间范围 快捷插入）
  * `SendButton`
  * `AdvancedOptions`（折叠）：行数上限、是否返回SQL、是否返回图表、异常判定方式（阈值/统计）
  * `Attachment`（可选）：上传说明/字段列表（后续）

---

## 1.3 组件：AssistantAnswerCard（每条回答标准结构）

**Frame: `AssistantAnswerCard`**

* 顶部：`AnswerMetaBar`

  * 状态：处理中/完成/失败
  * 耗时、行数、语义版本、traceId（点击可复制）
  * 操作：`查看推理过程`（打开 TraceDrawer）/ `复制SQL` / `导出` / `保存为模板`
* 内容区：`AnswerBody`

  * `SummaryBlock`（1-2行结论）
  * `KPIChips`（及时率、订单量、异常数…）
  * `VisualizationSlot`（折线/柱状/分布；无则隐藏）
  * `ResultTable`（TOPN明细，支持排序、分页、钻取）
* 底部：`TrustSignals`（可信度栏，默认展示）

  * 质量：新鲜度、空值率、规则命中（点开详情）
  * 安全：是否脱敏/聚合/行列权限裁剪提示
  * 口径：指标口径名称 + termId（可点开口径说明）

---

## 1.4 抽屉：TraceDrawer（推理过程/可审计）

**Frame: `TraceDrawer`（右侧抽屉，宽 520-680）**

* Header：traceId、任务状态、requestId、创建时间
* Tabs（三段式，默认“口径与理解”）

  1. `口径与理解`（面向业务）

     * 解析结果：指标/维度/范围/输出形态
     * 不确定项（Ambiguities）以 chips 展示：点击即“重算”（触发新任务）
  2. `数据与约束`（面向可信度）

     * 语义落地：选用业务对象、表清单、字段映射（字段→列）
     * 权限与脱敏：裁剪规则说明
     * 质量信号：新鲜度、空值率、异常规则命中
  3. `执行与复现`（面向分析/诊断）

     * Query Plan（步骤列表）
     * SQL（可复制）
     * 执行统计：扫描行数/耗时/缓存命中/分页信息
     * 失败时：错误码、错误类型、重试建议、日志摘要（管理员）

> 权限控制：Tabs 3 中“工具日志/Prompt版本/模型信息”仅管理员可见；业务用户只见 SQL/计划/统计。

---

## 1.5 右侧：SidePanel（场景示例 + 最近查询）

**Frame: `SidePanel`**

* `ScenarioExamples`

  * 卡片：标题、描述、预期输出类型（表/图/告警）、默认域/时间范围
  * 点击：填充到输入框（可编辑）+ 展示口径提示（不直接执行）
* `RecentQueries`

  * 列表：问题、时间、状态、traceId
  * 操作：再次运行/收藏/分享链接
* `SavedTemplates`（可选）

  * 个人/团队模板

---

# 2. 后端接口契约（API Contract）

## 2.1 总体原则

* **异步任务化**：Ask 请求返回 `taskId/traceId`，前端通过 **SSE 流式事件**或轮询获取阶段进度与结果。
* **每阶段均可回传结构化产物**：用于 UI 渲染与审计。
* **强制返回 requestId**：用于排障；失败必须返回标准错误结构（见错误码规范）。

---

## 2.2 创建会话（可选；若你们已有会话体系可复用）

### POST `/api/qna/sessions`

**Req**

```json
{ "domainId": "supply_chain", "semanticVersionId": "semver_1_3" }
```

**Resp**

```json
{ "sessionId": "sess_xxx" }
```

---

## 2.3 发起问数任务（核心）

### POST `/api/qna/ask`

**Req**

```json
{
  "sessionId": "sess_xxx",
  "question": "统计近30天供应商交付及时率，列出TOP10异常供应商",
  "context": {
    "domainId": "supply_chain",
    "semanticVersionId": "semver_1_3",
    "timeRange": { "type": "last_n_days", "value": 30 },
    "locale": "zh-CN"
  },
  "options": {
    "returnSql": true,
    "returnChart": true,
    "rowLimit": 200,
    "anomaly": { "type": "threshold", "threshold": 0.9, "minCount": 50 }
  }
}
```

**Resp（异步）**

```json
{
  "taskId": "task_xxx",
  "traceId": "trace_xxx",
  "requestId": "req_xxx",
  "status": "queued"
}
```

---

## 2.4 任务事件流（推荐：SSE）

### GET `/api/qna/tasks/{taskId}/events`  （Content-Type: text/event-stream）

**事件类型（示例）**

* `stage.started`
* `stage.completed`
* `stage.failed`
* `result.patch`（分片回传表格/图）
* `final.completed`

**事件 payload（统一结构）**

```json
{
  "taskId": "task_xxx",
  "traceId": "trace_xxx",
  "requestId": "req_xxx",
  "ts": 1730000000000,
  "event": "stage.completed",
  "stage": "ground",
  "data": { ...stageOutput... }
}
```

> 前端渲染策略：收到 `stage.completed` 立即更新 TraceDrawer 对应分段；收到 `result.patch` 增量渲染表格/图；收到 `final.completed` 解锁导出/保存操作。

---

## 2.5 任务状态查询（SSE 不可用时兜底）

### GET `/api/qna/tasks/{taskId}`

**Resp**

```json
{
  "taskId": "task_xxx",
  "traceId": "trace_xxx",
  "requestId": "req_xxx",
  "status": "running",
  "currentStage": "execute",
  "progress": { "pct": 65 },
  "updatedAt": 1730000000000
}
```

---

## 2.6 获取最终结果（或直接从事件流拼装）

### GET `/api/qna/tasks/{taskId}/result`

**Resp**

```json
{
  "status": "completed",
  "answer": {
    "summary": "近30天整体及时率为92.1%，异常供应商TOP10如下…",
    "kpis": [
      { "key": "ontime_rate", "label": "交付及时率", "value": 0.921, "format": "percent" }
    ],
    "table": {
      "columns": [
        { "key": "supplier", "label": "供应商" },
        { "key": "ontime_rate", "label": "及时率", "format": "percent" },
        { "key": "orders", "label": "订单量" }
      ],
      "rows": []
    },
    "chart": { "type": "line", "spec": {} },
    "trustSignals": {
      "quality": [
        { "type": "freshness", "level": "ok", "value": "T-2h" }
      ],
      "security": { "masked": false, "aggregated": false, "message": "" }
    },
    "artifacts": {
      "sql": "SELECT ...",
      "termRefs": [{ "termId": "metric.delivery_ontime_rate", "name": "交付及时率" }],
      "objectRefs": [{ "objectId": "bo_supplier_delivery", "name": "供应商交付" }]
    }
  }
}
```

---

## 2.7 获取 Trace（审计/复现）

### GET `/api/qna/traces/{traceId}`

**Resp（见 3. Trace Schema）**

---

# 3. Trace 状态机（State Machine）与 Schema

## 3.1 阶段定义（固定 6 阶段）

1. `parse`：意图解析（指标/维度/范围/输出形态/不确定项）
2. `ground`：语义落地（语义版本、业务对象、字段映射、权限裁剪）
3. `plan`：查询计划（步骤、异常检测方法、聚合策略）
4. `generate`：生成查询（SQL/DSL、参数绑定、限流策略）
5. `execute`：执行（扫描行数、耗时、分页、重试）
6. `explain`：解释生成（结论、证据、质量/安全提示、可复用资产）

---

## 3.2 状态机（任务维度）

**TaskStatus**

* `queued` → `running` → (`completed` | `failed` | `cancelled`)

**StageStatus**

* `pending` → `running` → (`ok` | `failed` | `skipped`)

**核心转移规则**

* 任一阶段 `failed` ⇒ Task `failed`（除非配置为可降级：例如 generate 失败可降级为“仅返回解析/落地结果”）
* 前端可触发 `cancel`：running → cancelled
* 用户点击 Ambiguity chip：创建新 task（保留 parentTraceId，形成 lineage）

---

## 3.3 Trace JSON Schema（最小可用 + 可扩展）

```json
{
  "traceId": "trace_xxx",
  "requestId": "req_xxx",
  "sessionId": "sess_xxx",
  "question": "…",
  "context": {
    "domainId": "supply_chain",
    "semanticVersionId": "semver_1_3",
    "timeRange": { "type": "last_n_days", "value": 30 }
  },
  "taskStatus": "completed",
  "stages": [
    {
      "name": "parse",
      "status": "ok",
      "startedAt": 1730000000000,
      "endedAt": 1730000000100,
      "output": {
        "metrics": [{ "name": "交付及时率", "termId": "metric.delivery_ontime_rate" }],
        "dimensions": [{ "name": "供应商", "termId": "dim.supplier" }],
        "filters": [{ "field": "date", "op": ">=", "value": "today-30d" }],
        "deliverables": ["topN", "anomaly_list"],
        "ambiguities": [
          { "key": "ontime_definition", "candidates": ["提前算及时", "提前不算及时"], "default": "提前算及时" }
        ]
      }
    },
    {
      "name": "ground",
      "status": "ok",
      "output": {
        "businessObject": { "objectId": "bo_supplier_delivery", "name": "供应商交付" },
        "tables": [
          { "name": "dwd_po_line", "type": "fact" },
          { "name": "dim_supplier", "type": "dim" }
        ],
        "fieldMapping": {
          "promise_date": "dwd_po_line.promise_arrival_date",
          "actual_date": "dwd_po_line.actual_arrival_date",
          "supplier": "dim_supplier.supplier_name"
        },
        "security": {
          "rowLevelFilter": "dept_id IN (...)",
          "masked": false,
          "aggregated": false
        }
      }
    },
    {
      "name": "plan",
      "status": "ok",
      "output": {
        "querySteps": [
          "取近30天订单行",
          "计算是否及时",
          "按供应商聚合及时率/订单量",
          "识别异常",
          "输出TOP10"
        ],
        "anomalyMethod": { "type": "threshold", "rule": "ontime_rate < 0.9 AND orders >= 50" }
      }
    },
    {
      "name": "generate",
      "status": "ok",
      "output": { "sql": "SELECT ...", "params": { "start_date": "..." } }
    },
    {
      "name": "execute",
      "status": "ok",
      "output": { "durationMs": 1830, "scannedRows": 1200341, "resultRows": 10 }
    },
    {
      "name": "explain",
      "status": "ok",
      "output": {
        "summary": "…",
        "qualitySignals": [{ "type": "freshness", "level": "ok", "value": "T-2h" }],
        "securityNotes": [],
        "artifacts": { "sqlRef": true }
      }
    }
  ],
  "error": null
}
```

---

# 4. 错误码规范（Error Code Spec）

## 4.1 统一错误响应结构

所有失败（含阶段失败）必须返回以下结构（HTTP 非 2xx 或 task 结果中 error 字段）：

```json
{
  "requestId": "req_xxx",
  "traceId": "trace_xxx",
  "taskId": "task_xxx",
  "error": {
    "code": "QNA-EXEC-QUERY_TIMEOUT",
    "httpStatus": 504,
    "stage": "execute",
    "type": "TIMEOUT",
    "message": "查询超时（30s）",
    "userHint": "建议缩小时间范围或增加筛选条件后重试。",
    "retryable": true,
    "actions": ["RETRY", "REDUCE_SCOPE", "RETURN_SQL_ONLY"],
    "details": {
      "timeoutMs": 30000,
      "dataSource": "dw_clickhouse"
    }
  }
}
```

前端渲染：`SystemErrorCard` 必须展示 `message + userHint + requestId`，并按 `actions` 显示按钮。

---

## 4.2 错误码命名规则

`QNA-{STAGE}-{CATEGORY}_{DETAIL}`

* STAGE：`PARSE | GROUND | PLAN | GEN | EXEC | EXPLAIN`
* CATEGORY：`AUTH | PERM | SEMANTIC | VALIDATION | DATASOURCE | SQL | TIMEOUT | NETWORK | MODEL | RATE | UNKNOWN`
* DETAIL：具体原因

---

## 4.3 错误码清单（P0 必备）

### 鉴权/权限

* `QNA-GROUND-AUTH_UNAUTHENTICATED`（401，不可重试）
* `QNA-GROUND-PERM_FORBIDDEN_FIELD`（403，不可重试，提示申请权限）
* `QNA-GROUND-PERM_ROW_FILTER_APPLIED`（200 但需提示：已裁剪；非错误）

### 语义与口径

* `QNA-PARSE-VALIDATION_AMBIGUOUS_INTENT`（400，可交互：返回 ambiguities）
* `QNA-GROUND-SEMANTIC_TERM_NOT_FOUND`（404，可切换语义版本或数据域）
* `QNA-GROUND-SEMANTIC_MAPPING_INCOMPLETE`（422，可提示缺字段、建议补齐映射）

### 数据源/SQL/执行

* `QNA-GEN-SQL_GENERATION_FAILED`（500，可重试/降级仅返回解析）
* `QNA-EXEC-DATASOURCE_UNAVAILABLE`（503，可重试）
* `QNA-EXEC-QUERY_TIMEOUT`（504，可重试；建议缩小范围）
* `QNA-EXEC-QUERY_SYNTAX_ERROR`（500，通常不可重试；提示联系管理员）
* `QNA-EXEC-RESULT_TOO_LARGE`（413，提示提高筛选或降低 rowLimit）

### 模型与限流

* `QNA-PARSE-MODEL_OVERLOADED`（503，可重试）
* `QNA-*-RATE_LIMITED`（429，可重试；返回 `retryAfterMs`）

### 网络（前端/网关层）

* `QNA-NETWORK_FETCH_FAILED`（0/520，前端映射；必须落到标准错误卡，不得裸露“Failed to fetch”）

---

## 4.4 前端动作映射（必须实现）

* `retryable=true` → 展示“重试”
* `actions` 包含：

  * `REDUCE_SCOPE`：弹出缩小范围面板（时间/维度/过滤）
  * `RETURN_SQL_ONLY`：切换 options.returnSql=true 且跳过 execute
  * `CHANGE_SEMVER`：打开语义版本选择
  * `REQUEST_ACCESS`：跳转权限申请（如你们有）

---

# 5. 关键交互与验收标准（P0）

## 5.1 不允许出现的体验

* 任何位置出现未解释的 “Failed to fetch”
* 失败后对话为空白、无 requestId/traceId
* 用户连续点击导致重复执行且无状态提示

## 5.2 必须满足的验收

* 每次 ask 返回 `taskId + traceId + requestId`
* 前端可见阶段进度（至少 parse/ground/execute 三段）
* 任意失败：展示错误卡（含 requestId、可操作按钮）
* TraceDrawer 可打开并看到至少：

  * 指标/维度/范围（parse output）
  * 表/字段映射（ground output）
  * SQL 与执行统计（generate/execute output，权限控制）

---

如果你希望我进一步把这份文档“变成可喂给大模型的开发任务包”，我可以按你们现有技术栈（例如 go-zero + 前端框架）补齐：

* 前端组件/状态管理（SSE 事件 reducer、任务缓存、重试策略）
* 数据库表结构（trace/task 表、索引、lineage）
* go-zero 接口定义（proto/REST、错误码中间件、requestId 注入）
