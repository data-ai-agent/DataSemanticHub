
# 0. 路由与页面定位

* `/agent-factory/templates/:templateId`

  * 同一页面支持：查看/编辑草稿、查看已发布版本（只读）、发起发布/灰度/回滚、调试、查看门禁报告、查看引用关系。

---

# 1. 智能设计器总布局

## 1.1 `Page: TemplateDesignerPage`

### `Frame: TemplateDesignerLayout`

* `TopHeader`

  * `BackButton`
  * `TitleBlock`

    * TemplateName
    * StatusBadge（Stable/Canary/Draft/Deprecated/Disabled）
    * TemplateId（copy）
  * `PrimaryActions`

    * `UseButton`（去使用）
    * `OpenDebugButton`（打开调试）
    * `SaveDraftButton`（保存草稿）
    * `ReleaseButton`（发布）
    * `RollbackButton`（回滚）
  * `MoreMenu`

    * 复制模板 / 导出配置 / 导入配置 / 查看审计 / 删除（软删）
* `VersionAndGovernanceBar`（**保留你们现有但做增强**）

  * `CurrentVersionBadge`（v2.1.0 Stable）
  * `EnvPointers`（Staging→v2.3.1 | Prod→v2.2.8）
  * `ReleaseGateStatusCard`（评测通过/未通过/未运行）
  * `GrayReleaseProgressCard`（Prod 20% / 暂停/继续）
  * `BoundRuntimePackCard`（绑定运行包名）
  * `ChangeLogSummary`（变更说明）
  * `QuickLinks`

    * 版本历史 / Diff / 从某版本拉草稿
* `MainBody`（左右两栏）

  * `LeftMainColumn`（编辑主体）
  * `RightConfigColumn`（配置面板）
* `StickyFooter`（可选）

  * `CompileAndValidateButton`（编译/校验）
  * `RunSmokeTestsButton`（跑用例）
  * 状态提示：未保存/校验失败/可发布

> **核心新增**：全局 `IssuesDrawer` 与 `CompileStatusIndicator`，把配置一致性校验做成第一公民。

---

# 2. 全局一致性校验与问题抽屉（P0 必做）

## 2.1 `Component: CompileStatusIndicator`（放在 VersionBar 右侧或 Header 下）

状态：

* ✅ `ReadyToRelease`
* ⚠️ `RunnableWithWarnings`
* ❌ `Blocked`（不可发布/不可灰度）

点击打开：

## 2.2 `Drawer: IssuesDrawer`

* `Tabs`

  * `阻断(P0)` / `警告(P1)` / `建议(P2)`
* `IssueItem`

  * 标题：如“Prompt 引用了未定义变量 {{time_range}}”
  * 位置：`Workflow/Prompt/Schema/Tools/KnowledgeSources`
  * 影响：调试失败 / 运行失败 / 输出不稳定 / 安全风险
  * 修复建议：具体到字段、按钮
  * `JumpToAnchorButton`
  * `AutoFixButton`（能自动的才出现）
* `Footer`

  * `ReRunCompileButton`

**典型阻断规则（建议内置）**

* Prompt 引用变量未在“输入配置”定义
* Workflow 使用工具未绑定/无权限/被禁用
* Output Schema 不合法（JSON schema invalid）或必填字段缺失（按能力类型）
* 绑定语义资产为空但选择了需要语义检索的骨架
* SQL 执行相关模块启用但 SQL 安全策略未启用
* 关键知识源版本过期且策略要求“强一致”（可配置）

---

# 3. 左侧主编辑区（LeftMainColumn）

> 以“分区 + 锚点导航”组织长页，保持你们当前块状布局。

## 3.1 `Component: SectionNav`（左侧顶部/悬浮）

锚点：

1. 基本信息
2. 绑定语义资产
3. 输入配置
4. 知识源
5. 角色指令（System Prompt）
6. 流程编排（Workflow/DSL）
7. 输出结构（Output Schema）
8. 运行限制与安全
9. 变更与发布信息（可选）

---

## 3.2 `Section: 基本信息 (BaseInfoSection)`

* `FormCard`

  * 模板名称（editable）
  * 能力类型（只读或谨慎允许变更）
  * 简介（textarea）
  * 业务域（select）
  * 分类（场景标签 multi-select）
  * 标签（tags input）

---

## 3.3 `Section: 绑定语义资产 (SemanticBindingsSection)`

* `BindingsGrid`

  * 语义版本（selector + 切换）
  * 业务对象范围（multi select）
  * 逻辑视图（selector）
  * 指标/术语标签（multi select）
  * 质量/安全策略引用（policy ref）
* `BindingPolicyCard`

  * “强一致/弱一致”策略：知识源过期是否阻断发布
  * “自动同步”选项（可选）
* `CTA`

  * `OpenSemanticAssetsButton`（跳到语义治理资产页）

---

## 3.4 `Section: 输入配置 (InputSchemaSection)`

* `InputFieldsHeader`

  * 字段列表标题
  * `AddFieldButton`
  * `ImportFromExampleButton`（从用例/调试输入生成字段）
* `InputFieldsList`

  * FieldCard：

    * 字段名 / 类型 / 必填（badge）
    * 来源：用户输入/会话上下文/语义资产/系统默认
    * 默认值（可选）
    * 校验规则（正则/枚举/范围）
    * UI 组件（text/select/dateRange）——用于“去使用”页面自动生成表单
    * 行操作：编辑/删除/排序
* `Drawer: FieldEditorDrawer`

  * 完整字段定义 + 预览（表单渲染预览）

---

## 3.5 `Section: 角色指令 (SystemPromptSection)`

* `PromptEditorCard`

  * 编辑器（支持变量插入）
  * `InsertVariableButton`
  * `PromptLintBadge`（引用变量检查、敏感词检查）
* `PromptGuardrailHints`

  * 风险注入检测、敏感词提示开关状态（只读显示来自全局策略）

---

## 3.6 `Section: 流程编排 (WorkflowSection)`

你们现在是模块卡片 + DSL 片段，非常好。增强点：**模块依赖可视化 + 模块级配置抽屉 + fallback**。

### 3.6.1 `WorkflowHeader`

* 当前骨架：问数骨架（可切换）
* `SwitchSkeletonButton`
* `OpenFlowEditorButton`（Flow Editor）

### 3.6.2 `WorkflowModuleGrid`

模块卡片（示例：语义检索/指标解析/SQL生成/解释与归因）

* `ModuleCard`

  * 模块名 + 状态（启用/禁用）
  * `DependencyChips`（**P0 新增**）

    * 工具：SemanticSearch / MetricResolver / SQLRunner
    * 知识源：指标库 v3.4
    * 安全：SQL 策略 v1
  * `ModuleLatencyBudget`（可选）
  * 行为：点击打开 `ModuleConfigDrawer`

### 3.6.3 `Drawer: ModuleConfigDrawer`

* `Tabs`

  1. 参数（module params）
  2. 工具（tool bindings）
  3. 知识源（retrieval settings）
  4. 降级（fallback）
  5. 输出片段（optional schema）
* `Tab: 工具`

  * 主工具选择（registry picker）
  * 备用工具链（ordered list）
  * 权限/限制提示（为什么不可用 + 申请入口）
* `Tab: 知识源`

  * topK、过滤条件、重排、是否启用缓存
* `Tab: 降级`

  * 失败条件：timeout/5xx/权限不足/预算超限
  * 降级动作：切小模型/不执行SQL/只返回SQL/返回解释模板
* `Tab: 参数`

  * 如 SQL 生成策略、归因窗口、置信度阈值等
* `Footer`

  * 保存模块配置 / 恢复默认

### 3.6.4 `WorkflowDSLPreviewCard`

* 显示当前 DSL 预览（只读）
* `InsertToolButton` / `InsertVariableButton`
* `DangerOpsLint`（危险操作 lint）

---

## 3.7 `Section: 输出结构 (OutputSchemaSection)`

### 3.7.1 `OutputTypeSelector`

* Text / JSON / 多段输出（你们已有）
* **增强**：按能力类型的 Schema 模板

  * `ApplySchemaTemplateDropdown`（QNA/SEM/KG/Report…）
  * `GenerateExampleOutputButton`

### 3.7.2 `SchemaEditorCard`

* JSON Schema 编辑器（带校验）
* 必填字段提示（由能力模板决定）
* `SchemaValidateBadge`（通过/失败）
* `SchemaDiffButton`（对比上个版本）

### 3.7.3 `ExampleAndRulesPanel`

* `SchemaRulesHintCard`（字段约束/枚举/长度）
* `GeneratedExampleOutputCard`（生成的示例，必须通过校验）
* `ExportSchemaButton`（给前端/后端消费）

---

## 3.8 `Section: 运行限制与安全 (RuntimeSafetySection)`

* `LimitsCard`

  * 最大耗时、最大扫描行数、分页策略
* `SQLSafetyPolicyCard`

  * SQL 安全策略：启用/禁用 + 版本
  * 允许语句类型：SELECT only 等（展示策略摘要）
* `DataAccessScopeCard`（可选）

  * 数据域范围、脱敏策略引用、审计等级

---

# 4. 右侧配置区（RightConfigColumn）

> 右侧保持你们的“配置面板”风格，但要让它更“收敛”：把和运行强相关的放右边，编辑内容放左边。

## 4.1 `Panel: KnowledgeSourcesPanel`

* 列表：

  * 业务知识网络（版本、连接状态）
  * 指标库（版本、连接状态）
  * 文档库（版本、需要更新 badge）
* `RetrievalPolicySummary`

  * topK、过滤条件、重排、是否启用缓存
* CTA：

  * 更新/同步
  * 打开详情

## 4.2 `Panel: ToolsAndSkillsPanel`

* 工具列表（绑定到模板的工具）

  * 名称、权限等级、超时、可用/限制 badge
* `AddFromRegistryButton`
* `RequestPermissionEntry`（限制时出现）
* `ToolHealthMini`（可选：错误率/延迟）

## 4.3 `Panel: ModelConfigPanel`

* 默认模型（picker，来自模型池）
* fallback 模型（picker）
* temperature/max_tokens
* `ModelRoutingHint`（如果启用路由策略，显示策略名）

## 4.4 `Panel: ExperienceConfigPanel`

* 长期记忆（开关）
* 相关问题推荐（开关）
* 默认开场白（自动生成/手动填写）
* 预设问题列表（可拖拽排序）
* `PreviewInUsePageButton`（预览“去使用”页面效果）

## 4.5 `Panel: GovernancePanel`（轻量摘要）

* 预算/限额摘要（来自全局配额）
* 当前模板运行风险等级（低/中/高）
* 关键门禁项摘要（通过/失败）

---

# 5. 调试与评测（从设计器跳转/弹层）

## 5.1 `Modal/Page: DebugConsole`

* 输入：选择用例/手输（自动渲染输入字段）
* 运行：选择环境（Staging/Prod shadow）、选择版本（草稿/已发布）
* 输出：结构化结果 + Trace 关键步骤（不展示模型思维，仅展示步骤日志/工具调用/证据）
* `SaveAsTestCaseButton`（保存为用例）

## 5.2 `Drawer/Page: GateReportViewer`

* 门禁报告（通过/失败）
* 失败项定位（跳转到对应 Section）
* 支持一键重跑（选择样本集）

---

# 6. 发布与回滚向导（P0 建议做向导，不要直接发布）

## 6.1 `Modal: ReleaseWizard`

* Step1：选择目标环境（Staging/Prod）
* Step2：选择发布策略

  * 全量 / 灰度（10/20/50…）/ 白名单
* Step3：门禁检查

  * 必须通过的项（schema 校验/安全策略/回归用例）
* Step4：确认影响

  * 影响运行包、预估调用量、回滚点
* Step5：执行发布

  * 进度、失败原因（错误码）、operationId

## 6.2 `Modal: RollbackWizard`

* 选择回滚到哪个版本
* 显示差异摘要（Prompt/Workflow/Schema/Tools）
* 影响评估（流量、运行包）
* 执行回滚

---

# 7. 页面状态与权限（必须定义）

## 7.1 编辑模式状态

* `ReadOnlyPublishedVersion`：查看已发布版本（不可编辑）
* `DraftEditing`：编辑草稿（可保存、可调试）
* `DirtyState`：未保存提示（离开确认）

## 7.2 权限控制

* Viewer：只能查看/去使用
* Editor：可编辑草稿、保存、调试
* Publisher：可发布/灰度/回滚
* Operator/Admin：可禁用工具、改安全策略引用、强制下线

---

# 8. 你们现有页面建议的“最小改动优先级”

## P0（必须，直接提升稳定性）

1. `CompileStatusIndicator + IssuesDrawer`（变量/工具/schema/策略一致性校验）
2. `ModuleConfigDrawer`（模块依赖可视化、工具绑定、fallback）
3. `OutputSchema` 按能力类型提供模板 + 校验 + 示例联动
4. `ReleaseWizard`（发布前门禁与影响评估）

## P1（提升可运营）

5. 知识源“需要更新”一键同步 + 同步后 smoke 回归
6. 工具“限制”提供原因+申请入口+fallback建议

## P2（增强竞争力）

7. 成本/延迟预算模拟器（改配置前后对比）
8. 片段库（Prompt/Workflow/Schema snippets）

---