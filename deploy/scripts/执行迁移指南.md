# 数据库迁移执行指南

## 问题说明

从宿主机运行迁移脚本时，`.env` 文件中的 `DB_HOST=mariadb` 是容器内的主机名，无法从宿主机访问。

## 解决方案

### 方案一：使用 localhost（推荐）

从宿主机运行时，覆盖 `DB_HOST` 环境变量：

```bash
cd /Users/kingnet/workspace/github_workspace/DataSemanticHub

# 方式1：临时设置环境变量
DB_HOST=localhost ./deploy/scripts/run-migrations.sh --service system-service

# 方式2：使用专门的本地执行脚本
./deploy/scripts/run-migrations-local.sh --service system-service
```

**注意**：需要确保 `.env` 文件中有正确的 `DB_PASSWORD`，或者通过环境变量提供：

```bash
DB_HOST=localhost DB_PASSWORD=your_password ./deploy/scripts/run-migrations.sh --service system-service
```

### 方案二：在容器内执行（最简单）

如果 MariaDB 容器正在运行，可以直接在容器内执行：

```bash
# 进入 MariaDB 容器
docker exec -it datasemantichub-mariadb bash

# 在容器内执行迁移（需要先挂载代码或复制迁移文件）
# 或者从宿主机执行：
docker exec -i datasemantichub-mariadb mysql -uroot -p${DB_PASSWORD} datasemantichub < services/app/system-service/migrations/system/add_icon_to_menus.sql
```

### 方案三：直接执行 SQL（最快）

如果只需要执行单个迁移文件：

```bash
cd /Users/kingnet/workspace/github_workspace/DataSemanticHub

# 从 .env 文件读取密码（需要先 source）
source deploy/.env

# 执行迁移
mysql -h 127.0.0.1 -P 3306 -u root -p${DB_PASSWORD} datasemantichub < services/app/system-service/migrations/system/add_icon_to_menus.sql
```

### 方案四：使用 MySQL 客户端

1. 连接到数据库：
```bash
mysql -h 127.0.0.1 -P 3306 -u root -p datasemantichub
```

2. 执行 SQL：
```sql
ALTER TABLE `menus` 
ADD COLUMN `icon` VARCHAR(64) NULL DEFAULT NULL COMMENT '图标名称（如 Layout, Database）' 
AFTER `permission_key`;
```

## 验证迁移

执行后验证字段是否添加成功：

```sql
-- 查看表结构
DESC menus;

-- 或者查看 icon 字段
SHOW COLUMNS FROM menus LIKE 'icon';
```

## 常见问题

### 1. 连接被拒绝

**错误**：`ERROR 2013 (HY000): Lost connection to MySQL server`

**解决**：
- 确保 MariaDB 容器正在运行：`docker ps | grep mariadb`
- 使用 `localhost` 或 `127.0.0.1` 而不是 `mariadb`
- 检查端口是否正确：`docker ps | grep 3306`

### 2. 密码错误

**错误**：`ERROR 1045 (28000): Access denied`

**解决**：
- 检查 `.env` 文件中的 `DB_PASSWORD`
- 或者通过环境变量提供密码：`DB_PASSWORD=your_password`

### 3. 字段已存在

**错误**：`ERROR 1060 (42S21): Duplicate column name 'icon'`

**解决**：字段已存在，无需再次执行。可以跳过此迁移。

## 快速执行命令

```bash
# 一键执行（需要先设置密码）
cd /Users/kingnet/workspace/github_workspace/DataSemanticHub
source deploy/.env
mysql -h 127.0.0.1 -P 3306 -u root -p${DB_PASSWORD} datasemantichub < services/app/system-service/migrations/system/add_icon_to_menus.sql && echo "迁移成功！" || echo "迁移失败，请检查错误信息"
```
