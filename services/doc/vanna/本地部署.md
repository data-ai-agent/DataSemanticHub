è¿™æ˜¯ä¸€ä¸ª**å®Œå…¨æœ¬åœ°åŒ–ã€å¼€ç®±å³ç”¨**çš„ Vanna éƒ¨ç½²æ–¹æ¡ˆã€‚

è¿™ä¸ªæ–¹æ¡ˆåŒ…å«äº†ä¸€å¥—å®Œæ•´çš„ **Docker Compose** é…ç½®ï¼Œå®ƒä¼šåœ¨ä½ çš„ç”µè„‘ä¸Šå¯åŠ¨ä¸¤ä¸ªå®¹å™¨ï¼š

1. **Vanna App**ï¼šåŒ…å« Web ç•Œé¢ã€å‘é‡æ•°æ®åº“ (ChromaDB) å’Œ Python é€»è¾‘ã€‚
2. **MySQL**ï¼šä¸€ä¸ªæµ‹è¯•ç”¨çš„æœ¬åœ°æ•°æ®åº“ï¼ˆè‡ªå¸¦ä¸€äº›æµ‹è¯•æ•°æ®ï¼‰ï¼Œè®©ä½ å¯åŠ¨åç«‹é©¬èƒ½ç©ã€‚

### ğŸ“‚ 1. é¡¹ç›®ç›®å½•ç»“æ„

è¯·åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆä¾‹å¦‚ `my-local-vanna`ï¼‰ï¼Œå¹¶åˆ›å»ºä»¥ä¸‹ 4 ä¸ªæ–‡ä»¶ï¼š

```text
my-local-vanna/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ app.py
â””â”€â”€ docker-compose.yml

```

---

### ğŸ“„ 2. æ–‡ä»¶å†…å®¹

#### 1) `requirements.txt`

è¿™æ˜¯ Python ä¾èµ–åŒ…ã€‚

```text
vanna[chromadb,flask,mysql]
openai
pymysql
pandas
plotly

```

#### 2) `Dockerfile`

æ„å»º Vanna çš„è¿è¡Œç¯å¢ƒã€‚

```dockerfile
FROM python:3.9-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆç¼–è¯‘ ChromaDB éœ€è¦ï¼‰
RUN apt-get update && apt-get install -y build-essential curl && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app.py .

# åˆ›å»ºå‘é‡åº“æŒä¹…åŒ–ç›®å½•
RUN mkdir /app/chroma_db

EXPOSE 8084

CMD ["python", "app.py"]

```

#### 3) `docker-compose.yml`

è¿™æ˜¯æ ¸å¿ƒç¼–æ’æ–‡ä»¶ã€‚å®ƒå®šä¹‰äº† **Vanna æœåŠ¡** å’Œ **MySQL æ•°æ®åº“**ã€‚
*æ³¨æ„ï¼šè¿™é‡Œæˆ‘å·²ç»é¢„ç½®äº† MySQL çš„ root å¯†ç ä¸º `123456`ï¼Œæ•°æ®åº“åä¸º `testdb`ã€‚*

```yaml
version: '3.8'

services:
  # 1. Vanna åº”ç”¨æœåŠ¡
  vanna-app:
    build: .
    container_name: local-vanna
    ports:
      - "8084:8084"
    depends_on:
      - mysql-db
    environment:
      # --- æ¨¡å¼é€‰æ‹© (äºŒé€‰ä¸€) ---
      
      # æ¨¡å¼ A: ä½¿ç”¨ DeepSeek/OpenAI (æ¨èï¼Œæ•ˆæœå¥½)
      USE_OLLAMA: "false"
      LLM_API_KEY: "sk-xxxxxxxxxxxx"  # ğŸ”´ è¿™é‡Œå¡«ä½ çš„ Key
      LLM_MODEL: "deepseek-chat"
      LLM_BASE_URL: "https://api.deepseek.com"

      # æ¨¡å¼ B: ä½¿ç”¨æœ¬åœ° Ollama (å®Œå…¨ç¦»çº¿ï¼Œéœ€æœ¬æœºå·²è£… Ollama)
      # USE_OLLAMA: "true"
      # OLLAMA_MODEL: "qwen2.5-coder:7b"
      # OLLAMA_HOST: "http://host.docker.internal:11434"

      # --- æ•°æ®åº“é…ç½® ---
      DB_HOST: "mysql-db"
      DB_USER: "root"
      DB_PASS: "123456"
      DB_NAME: "testdb"
    volumes:
      - ./vanna_data:/app/chroma_db  # æŒä¹…åŒ–å‘é‡æ•°æ®

  # 2. æœ¬åœ°æµ‹è¯•æ•°æ®åº“ (MySQL)
  mysql-db:
    image: mysql:8.0
    container_name: local-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: testdb
    ports:
      - "3306:3306"
    volumes:
      - ./mysql_data:/var/lib/mysql
    # å¯åŠ¨æ—¶åˆå§‹åŒ–å»ºè¡¨ (ç¨å¾®ç­‰å‡ åç§’è®©å®ƒå¯åŠ¨)
    healthcheck:
        test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
        timeout: 20s
        retries: 10

```

#### 4) `app.py`

è¿™æ˜¯åº”ç”¨ç¨‹åºçš„å…¥å£ä»£ç ã€‚å®ƒä¼šè‡ªåŠ¨åˆ¤æ–­ç¯å¢ƒå˜é‡æ¥å†³å®šæ˜¯è¿æ¥äº‘ç«¯å¤§æ¨¡å‹è¿˜æ˜¯æœ¬åœ° Ollamaï¼Œå¹¶è‡ªåŠ¨åœ¨æ•°æ®åº“é‡Œåˆ›å»ºä¸€å¼ æµ‹è¯•è¡¨ã€‚

```python
import os
import time
from vanna.flask import VannaFlaskApp
from vanna.chromadb import ChromaDB_VectorStore

# === 1. æ ¹æ®ç¯å¢ƒå˜é‡é…ç½® Vanna ===
use_ollama = os.getenv("USE_OLLAMA", "false").lower() == "true"

if use_ollama:
    # --- æœ¬åœ° Ollama æ¨¡å¼ ---
    from vanna.ollama import Ollama
    class MyVanna(ChromaDB_VectorStore, Ollama):
        def __init__(self, config=None):
            ChromaDB_VectorStore.__init__(self, config=config)
            Ollama.__init__(self, config=config)
    
    config = {
        'model': os.getenv("OLLAMA_MODEL", "qwen2.5-coder:7b"),
        'ollama_host': os.getenv("OLLAMA_HOST", "http://host.docker.internal:11434"),
        'path': '/app/chroma_db'
    }
    print(f"ğŸš€ æ­£åœ¨ä½¿ç”¨æœ¬åœ° Ollama æ¨¡å‹: {config['model']}")
else:
    # --- OpenAI/DeepSeek æ¨¡å¼ ---
    from vanna.openai import OpenAI_Chat
    class MyVanna(ChromaDB_VectorStore, OpenAI_Chat):
        def __init__(self, config=None):
            ChromaDB_VectorStore.__init__(self, config=config)
            OpenAI_Chat.__init__(self, config=config)

    config = {
        'api_key': os.getenv("LLM_API_KEY"),
        'model': os.getenv("LLM_MODEL", "deepseek-chat"),
        'base_url': os.getenv("LLM_BASE_URL", "https://api.deepseek.com"),
        'path': '/app/chroma_db'
    }
    print(f"ğŸš€ æ­£åœ¨ä½¿ç”¨äº‘ç«¯ API æ¨¡å‹: {config['model']}")

vn = MyVanna(config=config)

# === 2. è¿æ¥æ•°æ®åº“ ===
# ç­‰å¾… MySQL å¯åŠ¨
print("â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨...")
time.sleep(10) 

vn.connect_to_mysql(
    host=os.getenv("DB_HOST", "mysql-db"),
    dbname=os.getenv("DB_NAME", "testdb"),
    user=os.getenv("DB_USER", "root"),
    password=os.getenv("DB_PASS", "123456"),
    port=3306
)

# === 3. åˆå§‹åŒ–æµ‹è¯•æ•°æ® (ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿) ===
# æ¯æ¬¡å¯åŠ¨å°è¯•åˆ›å»ºä¸€å¼ è¡¨ï¼Œå¦‚æœæœ‰å°±ä¸åˆ›å»º
try:
    vn.run_sql("""
        CREATE TABLE IF NOT EXISTS customers (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100),
            email VARCHAR(100),
            signup_date DATE,
            total_spent DECIMAL(10, 2) COMMENT 'ç´¯è®¡æ¶ˆè´¹é‡‘é¢'
        );
    """)
    # æ’å…¥ç‚¹å‡æ•°æ®
    count = vn.run_sql("SELECT count(*) as c FROM customers")
    if count.iloc[0]['c'] == 0:
        vn.run_sql("""
            INSERT INTO customers (name, email, signup_date, total_spent) VALUES 
            ('Alice', 'alice@example.com', '2023-01-15', 1200.50),
            ('Bob', 'bob@example.com', '2023-02-20', 500.00),
            ('Charlie', 'charlie@example.com', '2023-03-10', 3000.00);
        """)
        print("âœ… æµ‹è¯•æ•°æ®å·²æ’å…¥")
        
        # ğŸ”¥ å…³é”®ï¼šè®­ç»ƒ Vanna è®¤è¯†è¿™å¼ è¡¨
        vn.train(ddl="""
            CREATE TABLE customers (
                id INT AUTO_INCREMENT PRIMARY KEY,
                name VARCHAR(100),
                email VARCHAR(100),
                signup_date DATE,
                total_spent DECIMAL(10, 2) COMMENT 'ç´¯è®¡æ¶ˆè´¹é‡‘é¢'
            );
        """)
        print("âœ… Vanna å·²å®Œæˆé’ˆå¯¹ customers è¡¨çš„è®­ç»ƒ")
except Exception as e:
    print(f"âš ï¸ æ•°æ®åº“åˆå§‹åŒ–è­¦å‘Š (éè‡´å‘½): {e}")

# === 4. å¯åŠ¨ Web æœåŠ¡ ===
app = VannaFlaskApp(vn, title="æœ¬åœ° Vanna æ¼”ç¤º", allow_llm_to_see_data=True)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8084, debug=True)

```

---

### ğŸš€ 3. å¦‚ä½•è¿è¡Œ

#### ç¬¬ä¸€æ­¥ï¼šé…ç½® Key (å¦‚æœä¸ä½¿ç”¨ Ollama)

æ‰“å¼€ `docker-compose.yml`ï¼Œåœ¨ `LLM_API_KEY` å¤„å¡«å…¥ä½ çš„ DeepSeek æˆ– OpenAI Keyã€‚

#### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨

åœ¨ç»ˆç«¯è¿›å…¥è¯¥ç›®å½•ï¼Œè¿è¡Œï¼š

```bash
docker-compose up --build

```

#### ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8084`
2. ä½ ä¼šçœ‹åˆ°ä¸€ä¸ªèŠå¤©ç•Œé¢ã€‚
3. **ç›´æ¥æé—®**ï¼ˆå› ä¸ºæˆ‘ä»¬åœ¨ä»£ç é‡Œå·²ç»è‡ªåŠ¨è®­ç»ƒäº† `customers` è¡¨ï¼‰ï¼š
* â€œæŸ¥ä¸€ä¸‹æ‰€æœ‰å®¢æˆ·çš„åå•â€
* â€œæ¶ˆè´¹æœ€é«˜çš„å®¢æˆ·æ˜¯è°ï¼Ÿâ€
* â€œå¸®æˆ‘ç”»ä¸ªå›¾ï¼Œå±•ç¤ºæ¯ä¸ªå®¢æˆ·çš„æ¶ˆè´¹é‡‘é¢â€



### ğŸ’¡ è¿›é˜¶ï¼šå¦‚ä½•ä½¿ç”¨çº¯æœ¬åœ°æ¨¡å‹ (Ollama)

å¦‚æœä½ æƒ³æ–­ç½‘è¿è¡Œï¼ˆå®Œå…¨æœ¬åœ°åŒ–ï¼‰ï¼š

1. ç¡®ä¿ä½ çš„å®¿ä¸»æœºï¼ˆMacï¼‰å®‰è£…äº† [Ollama](https://ollama.com/)ã€‚
2. åœ¨å®¿ä¸»æœºç»ˆç«¯æ‹‰å–æ¨¡å‹ï¼š`ollama pull qwen2.5-coder:7b` (æ¨èè¿™ä¸ªï¼Œå†™ SQL å¾ˆå¼º)ã€‚
3. ä¿®æ”¹ `docker-compose.yml`ï¼š
* **æ³¨é‡Šæ‰** æ¨¡å¼ A (DeepSeek) çš„éƒ¨åˆ†ã€‚
* **è§£å¼€** æ¨¡å¼ B (Ollama) çš„æ³¨é‡Šã€‚


4. é‡å¯ Dockerï¼š`docker-compose up --build`ã€‚

è¿™æ ·ï¼Œä½ çš„æ•°æ®ã€æ¨¡å‹ã€å‘é‡åº“å…¨éƒ¨åœ¨æœ¬åœ°è¿è¡Œï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®ä¼šå‘å¾€å…¬ç½‘ã€‚