.PHONY: init api swagger swagger-yaml gen lint test build clean docker-build docker-run k8s-deploy

# é¡¹ç›®åç§°
PROJECT_NAME := system-service

# Docker é…ç½®
DOCKER_REGISTRY := docker.io
DOCKER_IMAGE := $(DOCKER_REGISTRY)/$(PROJECT_NAME)
VERSION := $(shell cat VERSION 2>/dev/null || echo "0.1.0")

# Swagger æ–‡æ¡£è¾“å‡ºç›®å½•
SWAGGER_DIR := api/doc/swagger

# åˆå§‹åŒ–é¡¹ç›®
init:
	@./scripts/init.sh

# ç”Ÿæˆ API ä»£ç 
api:
	goctl api go -api api/doc/api.api -dir api/ --style=go_zero --type-group

# ç”Ÿæˆ Swagger æ–‡æ¡£ (JSON æ ¼å¼)
swagger:
	goctl api swagger --api api/doc/api.api --dir $(SWAGGER_DIR) --filename swagger

# ç”Ÿæˆ Swagger æ–‡æ¡£ (YAML æ ¼å¼)
swagger-yaml:
	goctl api swagger --api api/doc/api.api --dir $(SWAGGER_DIR) --filename swagger --yaml

# ä¸€é”®ç”Ÿæˆ API ä»£ç  + Swagger æ–‡æ¡£
gen: api swagger
	@echo "API code and Swagger documentation generated successfully!"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	gofmt -w .
	goimports -w .

# ä»£ç æ£€æŸ¥
lint:
	golangci-lint run ./...

# è¿è¡Œæµ‹è¯•
test:
	go test -v -cover ./...

# ç¼–è¯‘
build:
	CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/$(PROJECT_NAME) ./api

# è¿è¡Œ
run:
	go run api/api.go

# æ¸…ç†
clean:
	rm -rf bin/
	go clean

# å®‰è£…ä¾èµ–
deps:
	go mod tidy
	go mod download

# ============================================
# Docker å‘½ä»¤
# ============================================

# æ„å»º Docker é•œåƒ (ä½¿ç”¨ build.sh è„šæœ¬)
docker-build:
	@./deploy/docker/build.sh $(VERSION)

# è¿è¡Œ Docker å®¹å™¨
docker-run:
	docker run -d --name $(PROJECT_NAME) -p 8888:8888 $(DOCKER_IMAGE):$(VERSION)

# åœæ­¢ Docker å®¹å™¨
docker-stop:
	docker stop $(PROJECT_NAME) && docker rm $(PROJECT_NAME)

# æ¨é€ Docker é•œåƒ
docker-push:
	docker push $(DOCKER_IMAGE):$(VERSION)
	docker push $(DOCKER_IMAGE):latest

# ============================================
# Kubernetes å‘½ä»¤
# ============================================

# éƒ¨ç½²åˆ° K8s
# é»˜è®¤ç¯å¢ƒ
ENV ?= dev

# éƒ¨ç½²åˆ° K8s (é»˜è®¤ dev)
k8s-deploy:
	kubectl apply -k deploy/k8s/overlays/$(ENV)

# éƒ¨ç½²åˆ° K8s (Dev)
k8s-deploy-dev:
	kubectl apply -k deploy/k8s/overlays/dev

# éƒ¨ç½²åˆ° K8s (Prod)
k8s-deploy-prod:
	kubectl apply -k deploy/k8s/overlays/prod

# æŸ¥çœ‹ K8s ç”Ÿæˆçš„ Manifest (Dry-run)
k8s-manifest:
	kubectl kustomize deploy/k8s/overlays/$(ENV)

# åˆ é™¤ K8s éƒ¨ç½²
k8s-delete:
	kubectl delete -k deploy/k8s/overlays/$(ENV)

# æŸ¥çœ‹ K8s çŠ¶æ€
k8s-status:
	kubectl get pods,svc,deploy,ing -l app=$(PROJECT_NAME)

# å¸®åŠ©
help:
	@echo "Available commands:"
	@echo ""
	@echo "  Development:"
	@echo "    make init          - Initialize project"
	@echo "    make api           - Generate API code with goctl"
	@echo "    make swagger       - Generate Swagger JSON documentation"
	@echo "    make swagger-yaml  - Generate Swagger YAML documentation"
	@echo "    make gen           - Generate API code + Swagger docs"
	@echo "    make fmt           - Format code"
	@echo "    make lint          - Run linter"
	@echo "    make test          - Run tests"
	@echo "    make build         - Build binary"
	@echo "    make run           - Run server"
	@echo "    make clean         - Clean build artifacts"
	@echo "    make deps          - Install dependencies"
	@echo ""
	@echo "  Docker:"
	@echo "    make docker-build  - Build Docker image"
	@echo "    make docker-run    - Run Docker container"
	@echo "    make docker-stop   - Stop Docker container"
	@echo "    make docker-push   - Push Docker image to registry"
	@echo ""
	@echo "  Kubernetes (Kustomize):"
	@echo "    make k8s-deploy      - Deploy to K8s (default: dev)"
	@echo "    make k8s-deploy-dev  - Deploy to K8s Dev environment"
	@echo "    make k8s-deploy-prod - Deploy to K8s Prod environment"
	@echo "    make k8s-manifest    - View generated manifest (dry-run)"
	@echo "    make k8s-delete      - Delete K8s deployment"
	@echo "    make k8s-status      - Check K8s status"
	@echo ""
	@echo "  Database Migrations:"
	@echo "    make migrate-up      - Run all pending migrations"
	@echo "    make migrate-down    - Rollback last migration"
	@echo "    make migrate-status  - Show migration status"
	@echo "    make migrate-create MODULE=<module> NAME=<name>  - Create new migration"

# ============================================
# Database Migration Commands
# ============================================

# æ•°æ®åº“é…ç½®ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
DB_HOST ?= localhost
DB_PORT ?= 3306
DB_NAME ?= datasemantichub
DB_USER ?= root
DB_PASSWORD ?=

# è¿ç§»å·¥å…·é…ç½®
MIGRATE := migrate
MIGRATIONS_DIR := migrations/versions
DB_URL := "mysql://$(DB_USER):$(DB_PASSWORD)@tcp($(DB_HOST):$(DB_PORT))/$(DB_NAME)?multiStatements=true"

# æ¨¡å—åˆ—è¡¨
MODULES := system user

# æ‰§è¡Œæ‰€æœ‰æ¨¡å—çš„è¿ç§»
migrate-up:
	@echo "ğŸ”¼ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	@for module in $(MODULES); do \
		echo ""; \
		echo "ğŸ“¦ æ¨¡å—: $$module"; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		$(MIGRATE) -path $(MIGRATIONS_DIR)/$$module -database $(DB_URL) up || exit 1; \
		echo "âœ… $$module è¿ç§»æˆåŠŸ"; \
	done
	@echo ""
	@echo "ğŸ‰ æ‰€æœ‰æ¨¡å—è¿ç§»å®Œæˆï¼"

# å›æ»šæ‰€æœ‰æ¨¡å—çš„æœ€åä¸€æ¬¡è¿ç§»
migrate-down:
	@echo "ğŸ”½ å›æ»šæ•°æ®åº“è¿ç§»..."
	@for module in $(MODULES); do \
		echo ""; \
		echo "ğŸ“¦ æ¨¡å—: $$module"; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		$(MIGRATE) -path $(MIGRATIONS_DIR)/$$module -database $(DB_URL) down 1 || exit 1; \
		echo "âœ… $$module å›æ»šæˆåŠŸ"; \
	done
	@echo ""
	@echo "ğŸ‰ æ‰€æœ‰æ¨¡å—å›æ»šå®Œæˆï¼"

# æŸ¥çœ‹æ‰€æœ‰æ¨¡å—çš„è¿ç§»çŠ¶æ€
migrate-status:
	@echo "ğŸ“Š æŸ¥çœ‹è¿ç§»çŠ¶æ€..."
	@echo ""
	@for module in $(MODULES); do \
		echo "ğŸ“¦ æ¨¡å—: $$module"; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		$(MIGRATE) -path $(MIGRATIONS_DIR)/$$module -database $(DB_URL) version 2>&1 || echo "  âš ï¸  æœªæ‰§è¡Œä»»ä½•è¿ç§»"; \
		echo ""; \
	done

# åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
migrate-create:
	@if [ -z "$(MODULE)" ]; then \
		echo "âŒ é”™è¯¯: è¯·æŒ‡å®šæ¨¡å—å"; \
		echo "ç”¨æ³•: make migrate-create MODULE=system NAME=add_new_field"; \
		exit 1; \
	fi
	@if [ -z "$(NAME)" ]; then \
		echo "âŒ é”™è¯¯: è¯·æŒ‡å®šè¿ç§»åç§°"; \
		echo "ç”¨æ³•: make migrate-create MODULE=system NAME=add_new_field"; \
		exit 1; \
	fi
	@echo "ğŸ“ åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶..."
	@$(MIGRATE) create -ext sql -dir $(MIGRATIONS_DIR)/$(MODULE) -seq $(NAME)
	@echo "âœ… è¿ç§»æ–‡ä»¶å·²åˆ›å»ºåœ¨ $(MIGRATIONS_DIR)/$(MODULE)/"
	@echo ""
	@echo "ğŸ’¡ åç»­æ­¥éª¤:"
	@echo "   1. ç¼–è¾‘ç”Ÿæˆçš„ .up.sql æ–‡ä»¶ï¼ˆæ·»åŠ å˜æ›´é€»è¾‘ï¼‰"
	@echo "   2. ç¼–è¾‘ç”Ÿæˆçš„ .down.sql æ–‡ä»¶ï¼ˆæ·»åŠ å›æ»šé€»è¾‘ï¼‰"
	@echo "   3. æ‰§è¡Œè¿ç§»: make migrate-up"

# å®‰è£…golang-migrateå·¥å…·
install-migrate-tool:
	@echo "ğŸ“¦ å®‰è£… golang-migrate å·¥å…·..."
	@if command -v brew >/dev/null 2>&1; then \
		echo "ä½¿ç”¨ Homebrew å®‰è£…..."; \
		brew install golang-migrate; \
	else \
		echo "âŒ æœªæ‰¾åˆ° Homebrew"; \
		echo "è¯·æ‰‹åŠ¨å®‰è£…: https://github.com/golang-migrate/migrate"; \
		exit 1; \
	fi
	@echo "âœ… å®‰è£…å®Œæˆ"
	@$(MIGRATE) -version
