# 用户管理模块 Specification

> **Branch**: `001-user_management`  
> **Spec Path**: `specs/001-user_management/`  
> **Created**: 2026-01-21  
> **Status**: Draft

---

## Overview

实现用户管理模块，提供用户的全生命周期管理能力，包括用户的创建、查询、更新、删除、状态管理、角色绑定等功能。该模块基于现有的user表进行扩展，不需要单独创建新的用户表。该模块需要与现有注册功能打通，确保通过注册功能创建的用户能够正常纳入用户管理体系。

用户管理模块是平台的核心基础模块，采用职责与权限分离的设计理念，支持用户与组织、岗位、权限的复杂绑定关系。

---

## User Stories

### Story 1: 用户列表查询与筛选 (P1)

AS a 平台管理员/审批人/编辑者/只读用户
I WANT 查看用户列表，支持按部门、状态、权限角色等条件筛选
SO THAT 我可以快速找到目标用户并了解用户分布情况

**独立测试**: 能够通过API查询用户列表，支持分页、关键词搜索、多维度筛选和排序

### Story 2: 用户详情查询 (P1)

AS a 平台管理员/审批人/编辑者/只读用户
I WANT 查看用户完整信息，包括基本信息、角色绑定、审计日志
SO THAT 我可以全面了解用户情况和操作历史

**独立测试**: 能够通过用户ID查询用户详细信息，包括角色绑定和审计日志

### Story 3: 创建用户与邀请机制 (P1)

AS a 平台管理员
I WANT 创建新用户并发送邀请邮件
SO THAT 新用户可以收到邀请并完成首次登录激活

**独立测试**: 能够创建用户，系统自动发送邀请邮件，新用户状态为"未激活"

### Story 4: 更新用户信息与角色绑定 (P1)

AS a 平台管理员
I WANT 更新用户基本信息和角色绑定
SO THAT 用户信息和权限能够及时调整

**独立测试**: 能够更新用户姓名、手机号、部门、角色绑定等信息，并记录审计日志

### Story 5: 批量更新用户状态 (P1)

AS a 平台管理员
I WANT 批量启用/停用/锁定用户
SO THAT 可以高效管理多个用户的状态

**独立测试**: 能够批量更新用户状态，操作前检查影响面，防止误操作关键责任人

### Story 6: 解锁用户 (P1)

AS a 平台管理员
I WANT 解锁被锁定的用户
SO THAT 用户可以恢复正常使用

**独立测试**: 能够解锁锁定状态的用户，状态变为"启用"

### Story 7: 删除/归档用户 (P1)

AS a 平台管理员
I WANT 删除或归档用户
SO THAT 离职或不需要的用户可以从系统中移除

**独立测试**: 删除前检查影响面，支持责任转交，实现软删除（归档状态）

### Story 8: 重置用户密码 (P1)

AS a 平台管理员
I WANT 重置本地账号用户的密码
SO THAT 用户可以重新获得登录权限

**独立测试**: 能够为本地账号用户重置密码，生成临时密码并通过邮件发送

### Story 9: 批量导入用户 (P2)

AS a 平台管理员
I WANT 从Excel/CSV文件批量导入用户
SO THAT 可以快速批量创建用户

**独立测试**: 能够导入Excel/CSV文件，批量创建用户，支持预览校验

### Story 10: 导出用户数据 (P2)

AS a 平台管理员/审批人
I WANT 导出符合条件的用户数据为Excel
SO THAT 可以进行数据分析和备份

**独立测试**: 能够根据筛选条件导出用户数据为Excel文件

### Story 11: 用户统计信息 (P2)

AS a 平台管理员/审批人/编辑者/只读用户
I WANT 查看用户管理的KPI统计数据
SO THAT 可以了解用户分布和活跃情况

**独立测试**: 能够查询用户总数、各状态用户数、活跃率等统计数据

### Story 12: 与注册功能打通 (P1)

AS a 系统
I WANT 用户通过注册功能创建后，自动纳入用户管理体系
SO THAT 注册用户能够享受完整的用户管理功能

**独立测试**: 注册用户创建时自动设置正确的状态（未激活）、账号来源（local），并能够通过用户管理接口查询和管理

---

## Acceptance Criteria (EARS)

### 正常流程

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-01 | 用户列表查询成功 | WHEN 用户请求用户列表并传入有效参数 | THE SYSTEM SHALL 返回分页用户列表，支持关键词搜索、多维度筛选和排序 |
| AC-02 | 用户详情查询成功 | WHEN 用户请求存在的用户详情 | THE SYSTEM SHALL 返回用户完整信息，包括角色绑定和审计日志 |
| AC-03 | 创建用户成功 | WHEN 管理员提交有效的用户创建请求 | THE SYSTEM SHALL 创建用户（状态为"未激活"），发送邀请邮件，返回用户ID |
| AC-04 | 更新用户信息成功 | WHEN 管理员提交有效的用户更新请求 | THE SYSTEM SHALL 更新用户信息，记录审计日志，返回成功 |
| AC-05 | 批量更新状态成功 | WHEN 管理员提交有效的批量状态更新请求 | THE SYSTEM SHALL 批量更新用户状态，返回成功和失败统计 |
| AC-06 | 解锁用户成功 | WHEN 管理员请求解锁锁定状态的用户 | THE SYSTEM SHALL 将用户状态从"锁定"变更为"启用"，记录操作日志 |
| AC-07 | 删除用户成功 | WHEN 管理员删除用户且无影响面或已转交责任 | THE SYSTEM SHALL 将用户状态变更为"归档"（软删除），返回成功 |
| AC-08 | 重置密码成功 | WHEN 管理员重置本地账号用户密码 | THE SYSTEM SHALL 生成临时密码，发送邮件通知，返回临时密码 |
| AC-09 | 批量导入成功 | WHEN 管理员上传有效的Excel/CSV文件 | THE SYSTEM SHALL 批量创建用户，返回成功和失败统计 |
| AC-10 | 导出用户数据成功 | WHEN 管理员请求导出用户数据 | THE SYSTEM SHALL 返回Excel文件流，包含符合条件的用户数据 |
| AC-11 | 统计信息查询成功 | WHEN 用户请求统计信息 | THE SYSTEM SHALL 返回用户总数、各状态用户数、活跃率等KPI指标 |
| AC-12 | 注册用户自动纳入管理 | WHEN 用户通过注册接口成功注册 | THE SYSTEM SHALL 创建用户时设置状态为"未激活"、账号来源为"local"，用户可通过管理接口查询 |

### 异常处理

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-20 | 参数校验失败 | WHEN 必填参数为空或格式不正确 | THE SYSTEM SHALL 返回400错误，提示具体参数错误 |
| AC-21 | 用户不存在 | WHEN 查询不存在的用户ID | THE SYSTEM SHALL 返回404错误，提示用户不存在 |
| AC-22 | 邮箱/手机号重复 | WHEN 创建或更新用户时邮箱/手机号已存在 | THE SYSTEM SHALL 返回409错误，提示邮箱/手机号已被使用；如果手机号为空则不检查重复 |
| AC-23 | 权限不足 | WHEN 非管理员尝试创建/更新/删除用户 | THE SYSTEM SHALL 返回403错误，提示无操作权限 |
| AC-24 | 邮箱不允许修改 | WHEN 尝试修改用户邮箱 | THE SYSTEM SHALL 返回400错误，提示邮箱不允许修改 |
| AC-25 | 不能操作自己 | WHEN 管理员尝试修改自己的权限角色或删除/锁定自己 | THE SYSTEM SHALL 返回400错误，提示不能对自己执行该操作 |
| AC-26 | 删除关键责任人 | WHEN 尝试删除/停用作为Owner或审批人的用户且未转交 | THE SYSTEM SHALL 返回422错误，提示影响面并列出相关对象 |
| AC-27 | 锁定原因必填 | WHEN 锁定用户时未提供锁定原因 | THE SYSTEM SHALL 返回400错误，提示锁定原因必填 |
| AC-28 | 仅本地账号可重置密码 | WHEN 尝试重置SSO账号用户密码 | THE SYSTEM SHALL 返回400错误，提示仅本地账号支持密码重置 |

---

## Edge Cases

| ID | Case | Expected Behavior |
|----|------|-------------------|
| EC-01 | 并发创建相同邮箱用户 | 仅第一个请求成功，其他返回409邮箱已存在 |
| EC-02 | 删除被引用的用户 | 检查影响面，要求转交责任或强制删除，否则拒绝 |
| EC-03 | 批量操作部分失败 | 返回成功和失败统计，列出每个失败项的具体原因 |
| EC-04 | 部门筛选包含子部门 | 筛选部门时，返回该部门及其所有子部门的用户 |
| EC-05 | 导出数据超过上限 | 单次导出超过10000条时，建议使用异步导出或分批导出 |
| EC-06 | 批量导入邮箱重复 | 跳过重复邮箱的行，记录错误但不中断导入流程 |
| EC-07 | 用户状态流转限制 | 只能按照业务规则允许的状态流转（如锁定不能直接变为停用） |
| EC-08 | 注册用户无默认部门 | 注册用户不需要设置默认部门，可通过用户管理界面后续补充部门信息 |

---

## Business Rules

| ID | Rule | Description |
|----|------|-------------|
| BR-01 | 邮箱唯一性 | 系统内邮箱地址必须唯一，不允许重复 |
| BR-02 | 手机号唯一性 | 系统内手机号如果提供则必须唯一，不允许重复；手机号为可选字段 |
| BR-03 | 状态流转规则 | 用户状态只能按以下规则流转：未激活→启用⇄停用，启用→锁定→解锁→启用，任何状态→归档 |
| BR-04 | 新用户默认状态 | 通过管理接口创建的新用户默认状态为"未激活"，首次登录后激活 |
| BR-05 | 注册用户状态 | 通过注册接口创建的用户默认状态为"未激活"，账号来源为"local" |
| BR-06 | 邮箱不可修改 | 用户邮箱创建后不允许修改，如需修改需走账号迁移流程 |
| BR-07 | 自我操作限制 | 用户不能修改自己的权限角色，不能锁定/停用/删除自己 |
| BR-08 | 关键责任人保护 | 删除/停用/锁定用户前，需检查用户是否为Owner或审批人，如有影响需先转交 |
| BR-09 | 权限角色与岗位职责分离 | 岗位职责（Position）和权限角色（Permission Role）是独立概念，可以组合使用 |
| BR-10 | 账号来源区分 | 账号来源分为"local"（本地注册）和"sso"（SSO同步），只有local账号支持密码重置 |
| BR-11 | 组织权限边界 | 暂不支持组织权限边界，所有管理员可管理所有用户 |
| BR-12 | 审计日志记录 | 所有用户创建、更新、状态变更、删除操作必须记录审计日志 |

---

## Data Considerations

### 用户基本信息

| Field | Description | Constraints |
|-------|-------------|-------------|
| id | 用户ID | UUID v7格式，36字符，主键 |
| name | 姓名 | 必填，2-50字符 |
| email | 邮箱 | 必填，符合邮箱格式，唯一，创建后不可修改 |
| phone | 手机号 | 可选，11位数字（中国大陆），如果提供则必须唯一 |
| deptId | 主部门ID | 必填，关联部门表 |
| status | 用户状态 | 必填，枚举值：未激活/启用/停用/锁定/归档 |
| accountSource | 账号来源 | 必填，枚举值：local/sso |
| lastLogin | 最后登录时间 | 可选，ISO 8601格式 |
| createdAt | 创建时间 | 自动生成，ISO 8601格式 |
| createdBy | 创建人 | 必填，用户ID |
| updatedAt | 更新时间 | 自动更新，ISO 8601格式 |
| updatedBy | 更新人 | 可选，用户ID |
| lockReason | 锁定原因 | 锁定时必填，字符串 |
| lockTime | 锁定时间 | 锁定时自动记录，ISO 8601格式 |
| lockBy | 锁定操作人 | 锁定时必填，用户ID |

### 角色绑定（RoleBinding）

| Field | Description | Constraints |
|-------|-------------|-------------|
| orgId | 组织/部门ID | 必填，关联部门表 |
| position | 岗位职责 | 可选，如"语义治理负责人"、"版本委员会成员"等 |
| permissionRole | 权限角色 | 可选，如"平台管理员"、"审批人"、"编辑者"、"只读用户" |

### 审计日志（AuditLog）

| Field | Description | Constraints |
|-------|-------------|-------------|
| id | 日志ID | 主键 |
| userId | 用户ID | 关联用户表 |
| action | 操作类型 | 如"创建"、"更新"、"锁定"、"解锁"、"删除" |
| operator | 操作人姓名 | 字符串 |
| operatorId | 操作人ID | 关联用户表 |
| timestamp | 操作时间 | ISO 8601格式 |
| changes | 变更内容 | JSON格式，记录字段的旧值和新值 |

### 与现有注册功能的数据映射

基于现有的user表结构，用户管理模块需要对现有字段进行扩展和调整：

| 注册功能字段 | 用户管理字段 | 说明 |
|-------------|-------------|------|
| FirstName + LastName | name | 注册时分别存储姓名和姓，管理模块需要支持完整姓名查询和展示 |
| Email | email | 直接映射，保持唯一性约束 |
| Organization | deptId/organization | 注册时的组织字段需要映射到主部门，注册用户不需要默认部门 |
| PasswordHash | passwordHash | 密码哈希存储方式一致 |
| Status (默认1) | status (未激活) | **需要修改**：注册时状态应设为"未激活"而非"启用" |
| - | accountSource | **需要新增字段**：注册用户设置为"local" |
| - | phone | **需要新增字段（可选）**：注册用户可以不提供手机号，可通过用户管理界面后续补充 |
| - | roleBindings | **需要新增表**：注册用户暂无默认角色绑定，可通过用户管理界面后续配置 |
| - | deptId | **需要新增字段（可选）**：注册用户不需要默认部门 |

---

## Success Metrics

| ID | Metric | Target |
|----|--------|--------|
| SC-01 | 用户列表查询响应时间 | < 500ms (1000条数据内，P99) |
| SC-02 | 批量操作支持规模 | 单次批量操作支持最多100条记录 |
| SC-03 | 导出功能支持规模 | 单次导出支持最多10,000条数据 |
| SC-04 | 接口可用性 | 99.9%可用性（排除计划维护时间） |
| SC-05 | 用户创建成功率 | 用户创建操作成功率 > 99.5% |
| SC-06 | 注册用户纳入管理完整性 | 100%的注册用户能够通过用户管理接口查询和管理 |

---

## Integration Requirements

### 与注册功能打通

1. **状态同步**: 注册功能创建用户时，状态应设置为"未激活"而非"启用"，确保用户首次登录时需要激活账号
2. **账号来源标识**: 注册功能创建的用户应设置`accountSource='local'`，用于区分本地注册和SSO同步用户
3. **数据映射**: 注册功能的`FirstName`和`LastName`需要合并为`name`字段，或用户管理模块支持姓名字段的拆分存储
4. **默认值处理**: 
   - 注册用户不需要设置默认部门，可通过用户管理界面后续补充
   - 注册用户可以不提供手机号（手机号为可选字段），可通过用户管理界面后续补充
   - 注册用户暂无默认的角色绑定，可通过用户管理界面后续配置
5. **首次登录激活**: 注册用户的"未激活"状态应在首次成功登录后自动变更为"启用"
6. **基于现有user表**: 用户管理模块基于现有的user表进行扩展，需要添加必要的字段（如accountSource、phone、deptId等），但不创建新的用户表

### API集成点

- 用户管理模块的创建用户接口应复用注册功能的用户创建逻辑，或注册功能调用用户管理模块的创建接口
- 用户查询接口应能够查询到通过注册功能创建的用户（基于现有user表）
- 用户状态更新接口应能够更新注册用户的状态
- 用户信息更新接口应支持补充手机号、部门、角色绑定等可选信息

---

## Open Questions

- [ ] 用户管理模块中的部门（deptId）和组织（organization）字段关系是什么？是否需要独立的部门管理模块？
- [ ] 角色绑定（RoleBinding）的数据表结构如何设计？是否需要独立的role_bindings表？
- [ ] 审计日志（AuditLog）的数据表结构如何设计？是否需要独立的audit_logs表？

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-21 | - | 初始版本 |
| 1.1 | 2026-01-21 | - | 澄清：基于现有user表扩展；注册用户不需要默认部门和角色绑定；手机号非必填；暂不支持组织权限边界；SSO集成暂不实现 |
