# Permission Template Specification

> **Branch**: `002-permission-template`
> **Spec Path**: `specs/002-permission-template/`
> **Created**: 2026-01-26
> **Feature Number**: 002

> **Status**: Draft

---

## Overview

系统提供权限模板（Permission Template）的生命周期管理能力，支持管理员创建、编辑、发布、停用、复制和删除标准权限模板。每个模板包含策略矩阵（模块×动作勾选）和可选的高级权限点，用于在角色创建时快速预填权限配置，提升角色管理效率。

---

## User Stories

### Story 1: 模板列表查询与筛选 (P1)

AS a 系统管理员
I WANT 查看权限模板列表并支持关键字搜索、状态筛选
SO THAT 我能快速找到合适的权限模板用于角色创建

**独立测试**: 管理员可以通过名称/编码关键字搜索，按状态（草稿/已发布/已停用）筛选，按更新时间排序查看模板列表

### Story 2: 模板详情查看 (P1)

AS a 系统管理员
I WANT 查看模板的完整策略矩阵和高级权限点
SO THAT 我能了解该模板包含哪些权限配置

**独立测试**: 管理员点击模板可查看其基本信息、策略矩阵详情、高级权限点配置以及使用统计（被引用角色数、最近应用时间）

### Story 3: 创建和编辑草稿模板 (P1)

AS a 系统管理员
I WANT 创建新的权限模板并编辑草稿状态模板的基本信息和策略
SO THAT 我能准备标准化的权限配置模板

**独立测试**: 管理员可以创建新模板（默认草稿状态），填写名称、编码、描述、适用范围、策略矩阵和高级权限点；草稿状态模板允许反复编辑

### Story 4: 发布和停用模板 (P1)

AS a 系统管理员
I WANT 发布完成配置的模板或停用不再使用的模板
SO THAT 我能控制模板的可用性，确保只有经过审核的模板用于角色创建

**独立测试**: 管理员可以将草稿模板发布为可用状态（发布时校验策略矩阵非空）；也可以将已发布模板停用使其不再用于新角色创建

### Story 5: 复制和删除模板 (P1)

AS a 系统管理员
I WANT 复制现有模板创建变体或删除不再需要的模板
SO THAT 我能快速创建相似模板，并清理废弃资源

**独立测试**: 管理员可以复制模板生成新的草稿模板（包含原模板的所有策略配置）；删除模板时系统会提示被引用角色数量，若被引用则拒绝删除

### Story 6: 从模板创建角色 (P2)

AS a 系统管理员
I WANT 在创建角色时选择权限模板预填权限策略
SO THAT 我能快速完成角色权限配置

**独立测试**: 管理员在新建角色时可选择模板，系统自动填充该模板的策略矩阵和高级权限点到角色权限配置中

---

## Acceptance Criteria (EARS)

### 正常流程

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-01 | 查询模板列表成功 | WHEN 管理员请求模板列表 | THE SYSTEM SHALL 返回分页的模板摘要信息（包含名称、编码、状态、适用范围、更新时间） |
| AC-02 | 关键字搜索成功 | WHEN 管理员输入名称或编码关键字搜索 | THE SYSTEM SHALL 返回匹配的模板列表 |
| AC-03 | 状态筛选成功 | WHEN 管理器按状态（draft/published/disabled）或适用范围（global/organization/domain/project）筛选 | THE SYSTEM SHALL 返回对应的模板列表 |
| AC-04 | 查看模板详情成功 | WHEN 管理员查询存在的模板ID | THE SYSTEM SHALL 返回完整模板信息（基本信息、策略矩阵、高级权限点、使用统计） |
| AC-05 | 创建模板成功 | WHEN 管理员提交有效的模板创建请求 | THE SYSTEM SHALL 创建草稿状态模板并返回模板ID |
| AC-06 | 编辑草稿模板成功 | WHEN 管理员编辑草稿状态的模板 | THE SYSTEM SHALL 保存修改并返回成功 |
| AC-07 | 发布模板成功 | WHEN 管理员发布草稿状态且策略矩阵非空的模板 | THE SYSTEM SHALL 将状态更新为published，生成新版本号，并返回成功 |
| AC-08 | 停用模板成功 | WHEN 管理员停用已发布的模板 | THE SYSTEM SHALL 将状态更新为disabled并返回成功 |
| AC-09 | 重新启用模板成功 | WHEN 管理员重新启用已停用的模板 | THE SYSTEM SHALL 将状态更新为published并返回成功 |
| AC-10 | 复制模板成功 | WHEN 管理员复制现有模板 | THE SYSTEM SHALL 创建包含相同策略的新草稿模板并返回新模板ID |
| AC-11 | 删除模板成功 | WHEN 管理员删除未被任何角色引用的模板 | THE SYSTEM SHALL 删除模板并返回成功 |
| AC-12 | 从模板创建角色成功 | WHEN 管理员在创建角色时选择模板 | THE SYSTEM SHALL 将模板当前版本的权限策略预填充到角色权限配置中，并记录模板版本号 |

### 异常处理

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-20 | 名称或编码为空 | WHEN 创建/编辑时名称或编码为空 | THE SYSTEM SHALL 返回业务错误码 200151 并提示必填字段缺失 |
| AC-21 | 编码冲突 | WHEN 创建/编辑时编码与已有模板重复 | THE SYSTEM SHALL 返回业务错误码 200152 并提示编码已存在 |
| AC-22 | 策略矩阵为空 | WHEN 创建或编辑时策略矩阵为空 | THE SYSTEM SHALL 返回业务错误码 200153 并提示策略矩阵必填 |
| AC-23 | 编辑非草稿模板 | WHEN 尝试编辑已发布或已停用的模板 | THE SYSTEM SHALL 返回业务错误码 200154 并提示只有草稿状态可编辑 |
| AC-24 | 发布空策略模板 | WHEN 尝试发布策略矩阵为空的模板 | THE SYSTEM SHALL 返回业务错误码 200155 并提示策略矩阵不能为空 |
| AC-25 | 发布非草稿模板 | WHEN 尝试发布非草稿状态的模板 | THE SYSTEM SHALL 返回业务错误码 200155 并提示只有草稿可发布 |
| AC-26 | 停用非发布模板 | WHEN 尝试停用非已发布状态的模板 | THE SYSTEM SHALL 返回业务错误码 200156 并提示只有已发布模板可停用 |
| AC-27 | 重新启用非停用模板 | WHEN 尝试重新启用非已停用状态的模板 | THE SYSTEM SHALL 返回业务错误码 200157 并提示只有已停用模板可重新启用 |
| AC-28 | 删除被引用模板 | WHEN 尝试删除被角色引用的模板 | THE SYSTEM SHALL 返回业务错误码 200158 并提示被引用角色数量，拒绝删除 |
| AC-29 | 模板不存在 | WHEN 查询/编辑/删除不存在的模板ID | THE SYSTEM SHALL 返回业务错误码 200159 |
| AC-30 | 权限不足 | WHEN 非管理员用户尝试操作模板 | THE SYSTEM SHALL 返回业务错误码 200160 |

---

## Edge Cases

| ID | Case | Expected Behavior |
|----|------|-------------------|
| EC-01 | 并发创建相同编码模板 | 仅一个创建成功，其他返回409编码冲突 |
| EC-02 | 并发编辑同一模板 | 采用乐观锁机制，最后提交的编辑失败并提示版本冲突 |
| EC-03 | 删除被大量角色引用的模板 | 返回业务错误码 200158 并显示具体被引用角色数量，建议先解除关联 |
| EC-04 | 复制已停用的模板 | 新生成的模板状态为草稿，继承原模板的所有策略配置 |
| EC-05 | 模板名称超过128字符 | 返回业务错误码 200161 并提示名称长度限制 |
| EC-06 | 停用被引用的模板 | 允许停用，但该模板不可再用于新建角色 |
| EC-07 | 查询使用统计为0的模板 | 返回used_by_role_count为0，last_applied_at为null |

---

## Business Rules

| ID | Rule | Description |
|----|------|-------------|
| BR-01 | 编码全局唯一 | 模板编码在全局范围内必须唯一，不可重复 |
| BR-02 | 状态流转限制 | draft → published → disabled，允许 disabled → published 重新启用 |
| BR-03 | 编辑权限控制 | 只有草稿状态允许编辑，已发布和已停用状态不可直接编辑 |
| BR-04 | 发布校验 | 发布时必须校验策略矩阵非空，否则禁止发布 |
| BR-05 | 删除保护 | 被角色引用的模板不允许删除，必须先解除角色关联 |
| BR-06 | 复制规则 | 复制生成的新模板状态重置为草稿，编码和名称需调整避免冲突 |
| BR-07 | 停用影响 | 已停用模板不可用于新建角色，但不影响已引用该模板的现有角色 |
| BR-08 | 版本管理 | 每次发布模板时生成递增版本号，角色关联时记录使用的模板版本号 |

---

## Data Considerations

| Field | Description | Constraints |
|-------|-------------|-------------|
| id | 模板唯一标识 | UUID v7格式，36字符 |
| name | 模板名称 | 必填，1-128字符 |
| code | 模板编码 | 必填，全局唯一，小写字母+数字+下划线+连字符 |
| description | 模板描述 | 可选，最大500字符 |
| status | 模板状态 | 枚举值：draft(草稿)/published(已发布)/disabled(已停用) |
| scope_suggestion | 推荐适用范围 | 可选，固定枚举值：global(全平台)/organization(组织)/domain(域)/project(项目)，存储在字典表中 |
| policy_matrix | 策略矩阵 | 必填，JSON格式，记录模块×动作的勾选关系 |
| advanced_perms | 高级权限点 | 可选，JSON格式，记录特殊权限配置 |
| created_by | 创建人ID | 必填，关联用户表 |
| created_at | 创建时间 | 必填，ISO8601格式 |
| updated_by | 最后更新人ID | 可选 |
| updated_at | 最后更新时间 | 必填，ISO8601格式 |
| deleted_at | 删除时间 | 可选，用于软删除 |
| used_by_role_count | 被引用角色数 | 统计字段，从角色关联表计算 |
| last_applied_at | 最近应用时间 | 统计字段，记录最近一次被用于创建角色的时间 |
| version | 版本号 | 必填，每次发布时递增，初始版本为1 |

### 策略矩阵 (policy_matrix) 结构

```json
{
  "模块编码": {
    "actions": ["动作1", "动作2"],
    "scope": "适用范围"
  }
}
```

示例：
```json
{
  "user_management": {
    "actions": ["create", "read", "update", "delete"],
    "scope": "organization"
  },
  "data_export": {
    "actions": ["export"],
    "scope": "domain"
  }
}
```

### 高级权限点 (advanced_perms) 结构

```json
{
  "权限点编码": {
    "enabled": true,
    "config": {}
  }
}
```

---

## Error Codes

**响应格式**: 所有 API 响应的 HTTP 状态码均为 200，业务异常通过响应体中的 `code` 字段表示（使用 idrm-go-base 统一响应格式）。

| Code | Description |
|------|-------------|
| 200151 | 模板名称或编码为空 |
| 200152 | 模板编码已存在 |
| 200153 | 策略矩阵不能为空 |
| 200154 | 只有草稿状态可编辑 |
| 200155 | 只有草稿状态可发布 |
| 200156 | 只有已发布状态可停用 |
| 200157 | 只有已停用状态可重新启用 |
| 200158 | 模板被角色引用，无法删除 |
| 200159 | 模板不存在 |
| 200160 | 权限不足 |
| 200161 | 模板名称长度超限 |
| 200162 | 模板描述长度超限 |
| 200163 | 适用范围枚举值无效 |
| 200164 | 并发编辑冲突 |
| 200165 | 模板版本冲突 |
| 200166 | 模板已被停用，不可用于创建角色 |
| 200167 | 策略矩阵格式错误 |
| 200168 | 高级权限点格式错误 |
| 200169 | 模板编码格式错误 |
| 200170 | 模板已被引用，禁止删除 |
| 200171 | 模板使用统计查询失败 |
| 200172 | 模板复制失败 |
| 200173 | 模板发布失败 |
| 200174 | 模板停用失败 |
| 200175 | 模板重新启用失败 |

---

## Success Metrics

| ID | Metric | Target |
|----|--------|--------|
| SC-01 | 模板创建成功率 | > 99% |
| SC-02 | 模板列表查询响应时间 | < 200ms (P95) |
| SC-03 | 模板详情查询响应时间 | < 150ms (P95) |
| SC-04 | 从模板创建角色的时间节省 | 相比手动配置减少70%时间 |
| SC-05 | 测试覆盖率 | > 80% |
| SC-06 | 模板复用率 | > 60%的角色使用模板创建 |

---

## Clarifications

### Session 2026-01-26

- Q: `scope_suggestion` 应该使用固定枚举值还是自由文本输入？ → A: 固定枚举值（预定义值如 'global'、'organization'、'domain'、'project'，存储在字典/配置中）
- Q: 是否允许已停用模板重新启用（disabled → published）？ → A: 允许重新启用，提供重新启用的API接口
- Q: 是否需要支持模板与角色关联的版本化？ → A: P1 实现，模板每次发布都生成版本号，角色记录使用的模板版本
- Q: 错误码范围 → A: 使用 200151-200175
- Q: HTTP 状态码与业务错误码的关系 → A: 所有 API 响应 HTTP 状态码均为 200，业务异常通过响应体中的 code 字段表示（遵循 idrm-go-base 统一响应格式）

---

## Open Questions

- [x] Q1: `scope_suggestion` 是否需要固定枚举值还是自由文本输入？**已澄清：使用固定枚举值**
- [x] Q2: 是否允许已停用模板重新启用（disabled → published）？**已澄清：允许重新启用**
- [x] Q3: 模板与角色的关联关系是否需要支持版本化？**已澄清：P1 实现版本化**
- [x] Q4: 错误码范围？**已澄清：200151-200175**
- [x] Q5: HTTP 状态码与业务错误码的关系？**已澄清：HTTP 状态码统一为 200，业务异常通过响应体 code 字段表示**

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-26 | - | 初始版本 |
| 1.1 | 2026-01-26 | - | 澄清 scope_suggestion 使用固定枚举值；允许已停用模板重新启用；P1 实现模板版本化；错误码范围 200151-200175；HTTP 状态码统一为 200，业务异常通过响应体 code 字段表示 |
