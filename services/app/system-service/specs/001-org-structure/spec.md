# 组织架构管理 Specification

> **Branch**: `001-org-structure`
> **Spec Path**: `specs/001-org-structure/`
> **Created**: 2025-01-25

> **Status**: Draft

---

## Overview

构建一个支持无限层级的组织架构管理系统，作为系统基础数据核心，支撑用户归属、数据权限范围以及审批流转功能。系统需要提供高性能的树形结构查询、灵活的层级调整、拖拽排序以及部门与用户的关联管理能力。

**核心能力**：
- 支持 CRUD 操作和层级管理（拖拽排序、层级调整）
- 高性能树操作（快速查询子树和溯源）
- 部门与用户、部门与负责人的关联管理
- 数据权限支撑（提供"本部门及子部门"的数据范围判定）

**用户补充要求**：
- 数据库创建时不增加外键约束
- 组织架构错误码使用 200100 - 200150 区间

---

## User Stories

### Story 1: 组织架构树形查询 (P1)

AS a 系统管理员
I WANT 以树形结构查看完整的组织架构
SO THAT 我能快速了解公司的组织层级关系

**独立测试**: 管理员可以展开/收起节点，查看任意层级的部门及其父子关系

### Story 2: 组织节点增删改 (P1)

AS a 系统管理员
I WANT 创建、编辑、删除组织节点
SO THAT 我能够维护组织架构的变更

**独立测试**: 成功创建新部门、修改部门信息、删除无子节点且无用户的部门

### Story 3: 组织移动与排序 (P2)

AS a 系统管理员
I WANT 通过拖拽移动部门到新的父节点，并调整同级排序
SO THAT 我能快速调整组织架构而不需要重新创建

**独立测试**: 拖拽部门到新位置后，该部门及其所有子部门自动移动到新父节点下，且祖先路径正确更新

### Story 4: 部门用户管理 (P2)

AS a 系统管理员
I WANT 查看部门下的用户列表，包括子部门用户
SO THAT 我能了解部门的人员构成

**独立测试**: 可以查看直属部门用户，也可选择递归查看所有子部门用户

### Story 5: 用户多部门关联 (P2)

AS a 系统管理员
I WANT 为用户设置主部门和辅助部门（兼任部门）
SO THAT 用户可以在数据权限上归属主部门，同时在协作场景中参与辅助部门

**独立测试**: 用户有一个主部门（用于数据权限），可以兼任多个其他部门，查询部门用户时能区分主部门和辅助部门

### Story 6: 部门负责人设置 (P3)

AS a 系统管理员
I WANT 为每个部门设置负责人
SO THAT 系统能基于部门负责人进行审批流转或消息通知

**独立测试**: 设置部门负责人后，该负责人信息在组织树中正确显示

---

## Acceptance Criteria (EARS)

### 正常流程

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-01 | 获取组织树成功 | WHEN 管理员请求组织架构树 | THE SYSTEM SHALL 返回完整的树形结构，包含节点层级关系、负责人信息、状态 |
| AC-02 | 创建组织节点成功 | WHEN 管理员提交有效的部门创建请求（父节点存在、同级名称唯一） | THE SYSTEM SHALL 创建部门，计算祖先路径（ancestors = 父节点ancestors + 父节点ID），返回创建的部门信息 |
| AC-03 | 更新组织节点成功 | WHEN 管理员提交有效的部门更新请求 | THE SYSTEM SHALL 更新部门信息，不支持通过此接口修改父节点 |
| AC-04 | 删除组织节点成功 | WHEN 管理员请求删除无子节点且无关联用户的部门 | THE SYSTEM SHALL 删除该部门（逻辑删除） |
| AC-05 | 移动组织节点成功 | WHEN 管理员拖拽部门到新父节点（非自身子孙节点） | THE SYSTEM SHALL 更新父节点，重新计算本节点及所有子孙节点的祖先路径，按顺序更新同级排序 |
| AC-06 | 查询部门用户成功 | WHEN 管理员查询部门用户列表 | THE SYSTEM SHALL 返回该部门的直属用户，若指定递归则包含所有子部门用户 |
| AC-07 | 设置部门负责人成功 | WHEN 管理员为部门设置有效的用户 ID 作为负责人 | THE SYSTEM SHALL 保存负责人 ID 并返回更新后的部门信息 |
| AC-08 | 停用组织节点成功 | WHEN 管理员停用无启用状态子节点的部门 | THE SYSTEM SHALL 更新部门状态为停用，该部门在用户管理的部门选择器中不可见 |

### 异常处理

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-10 | 参数校验失败 | WHEN 提交的必填字段（name、parent_id、type）缺失或格式错误 | THE SYSTEM SHALL 返回 400 错误码 200101，提示具体参数错误 |
| AC-11 | 父节点不存在 | WHEN 创建或移动部门时指定的父节点 ID 不存在 | THE SYSTEM SHALL 返回 404 错误码 200102，提示父节点不存在 |
| AC-12 | 同级名称重复 | WHEN 创建或更新部门时，同级存在相同名称的部门 | THE SYSTEM SHALL 返回 409 错误码 200103，提示部门名称已存在 |
| AC-13 | 删除有子节点的部门 | WHEN 请求删除包含子节点的部门 | THE SYSTEM SHALL 返回 400 错误码 200104，提示部门存在子节点，无法删除 |
| AC-14 | 删除有用户的部门 | WHEN 请求删除包含关联用户的部门 | THE SYSTEM SHALL 返回 400 错误码 200105，提示部门存在用户，无法删除 |
| AC-15 | 移动形成环路 | WHEN 移动部门到自身或其子孙节点下 | THE SYSTEM SHALL 返回 400 错误码 200106，提示不能移动到自己的子节点下 |
| AC-16 | 停用有启用子节点的部门 | WHEN 停用包含启用状态子节点的部门 | THE SYSTEM SHALL 返回 400 错误码 200107，提示存在启用状态的子节点 |
| AC-17 | 部门不存在 | WHEN 查询、更新、删除不存在的部门 ID | THE SYSTEM SHALL 返回 404 错误码 200108 |
| AC-18 | 根节点删除 | WHEN 尝试删除系统初始化的根节点 | THE SYSTEM SHALL 返回 403 错误码 200109，提示根节点不允许删除 |
| AC-19 | 设置主部门失败 | WHEN 为用户设置的主部门不存在或已停用 | THE SYSTEM SHALL 返回 400 错误码 200110，提示主部门无效 |
| AC-20 | 设置辅助部门重复 | WHEN 为用户添加已存在的辅助部门关联 | THE SYSTEM SHALL 返回 409 错误码 200111，提示该辅助部门关联已存在 |

---

## Edge Cases

| ID | Case | Expected Behavior |
|----|------|-------------------|
| EC-01 | 并发移动同一部门 | 仅一个操作成功，另一个返回冲突错误，ancestors 字段保持一致性 |
| EC-02 | 移动时批量更新子节点祖先路径失败 | 事务回滚，返回错误，保持数据一致性 |
| EC-03 | 深层级移动（移动包含上千子孙节点的部门） | 事务执行时间 < 5 秒，提供操作进度反馈或异步处理选项 |
| EC-04 | 递归查询子部门用户时部门层级过深 | 查询性能稳定，返回时间 < 2 秒 |
| EC-05 | 删除部门后重新创建同名部门 | 允许创建（逻辑删除），或物理删除后允许重用名称 |

---

## Business Rules

| ID | Rule | Description |
|----|------|-------------|
| BR-01 | 祖先路径规则 | ancestors 字段存储从根到父节点的完整路径，格式为 "0,101,105"，根节点为 "0" |
| BR-02 | 根节点保护 | 系统初始化的根节点不允许删除，仅允许修改名称 |
| BR-03 | 停用传播 | 部门停用后，在用户管理的部门选择器和角色数据范围选择中不可见 |
| BR-04 | 层级无限 | 系统支持无限层级，不限制嵌套深度 |
| BR-05 | 同级排序 | 同级部门按 sort_order 升序排列，sort_order 相同时按创建时间排序 |
| BR-06 | 负责人唯一性 | 一个部门只能有一个负责人，但一个用户可以担任多个部门的负责人 |
| BR-07 | 部门编码唯一性 | 部门编码（code）在全局范围内唯一，用于外部系统同步 |
| BR-08 | 数据权限范围 | 基于部门 ancestors 字段判定"本部门及子部门"的数据权限 |
| BR-09 | 用户主部门唯一性 | 一个用户必须有且仅有一个主部门，主部门用于数据权限判定 |
| BR-10 | 用户辅助部门 | 一个用户可以兼任多个辅助部门，辅助部门用于协作场景，不参与数据权限计算 |
| BR-11 | 操作审计记录 | 系统记录部门的关键操作（创建、删除、移动），不记录完整状态快照 |
| BR-12 | 数据权限缓存 | 用户登录时将主部门及所有子部门 ID 缓存，组织架构变更时主动失效缓存 |

---

## Data Considerations

### 组织表 (sys_organization)

| Field | Description | Constraints |
|-------|-------------|-------------|
| id | 主键 | UUID v7 格式，36 字符 |
| parent_id | 父部门 ID | 必填，根节点为 "0" |
| name | 部门名称 | 必填，1-100 字符，同级唯一 |
| code | 部门编码 | 可选，1-50 字符，全局唯一，用于业务标识 |
| ancestors | 祖先路径 | 必填，最长 500 字符，格式 "0,101,105" |
| sort_order | 同级排序 | 整数，默认 0 |
| leader_id | 部门负责人 ID | 可选，关联用户表 |
| type | 节点类型 | 必填，1=公司/租户根节点，2=部门/科室 |
| status | 状态 | 必填，1=启用，0=停用 |
| description | 备注 | 可选，最长 255 字符 |
| created_at | 创建时间 | 自动生成 |
| updated_at | 更新时间 | 自动更新 |
| deleted_at | 删除时间 | DATETIME(3) 类型，GORM 软删除需要毫秒精度 |

### 用户部门关联表 (sys_user_dept)

| Field | Description | Constraints |
|-------|-------------|-------------|
| id | 主键 | UUID v7 格式，36 字符 |
| user_id | 用户 ID | 必填，关联用户表 |
| dept_id | 部门 ID | 必填，关联部门表 |
| is_primary | 是否主部门 | 必填，true=主部门，false=辅助部门，一个用户只能有一条 is_primary=true 的记录 |
| created_at | 创建时间 | 自动生成 |

### 操作审计表 (sys_organization_audit)

| Field | Description | Constraints |
|-------|-------------|-------------|
| id | 主键 | UUID v7 格式，36 字符 |
| org_id | 部门 ID | 必填，关联被操作的部门 |
| operation | 操作类型 | 必填，create/delete/move |
| operator_id | 操作人 ID | 必填，关联用户表 |
| old_value | 旧值 | 可选，JSON 格式，记录关键字段变更前的值 |
| new_value | 新值 | 可选，JSON 格式，记录关键字段变更后的值 |
| created_at | 操作时间 | 自动生成 |

---

## Success Metrics

| ID | Metric | Target |
|----|--------|--------|
| SM-01 | 组织树查询响应时间 | < 500ms (P99)，包含 5000+ 节点 |
| SM-02 | 部门移动操作响应时间 | < 5 秒（包含 1000+ 子节点的情况） |
| SM-03 | 递归子部门用户查询 | < 2 秒（包含 10+ 层级） |
| SM-04 | 测试覆盖率 | > 80% |
| SM-05 | 并发操作一致性 | 100%（无数据不一致情况） |

---

## Open Questions

所有问题已通过用户澄清解决：

**Q1: 用户与部门的关联模式**
- **用户选择**: C - 主部门 + 辅助部门模式
- **说明**: 一个用户有一个主部门（用于数据权限），可以兼任多个其他部门（用于协作场景）
- **实现**: 引入 sys_user_dept 关联表，通过 is_primary 字段区分主部门和辅助部门

**Q2: 组织架构变更历史**
- **用户选择**: C - 仅记录关键操作
- **说明**: 轻量级审计日志，记录创建、删除、移动操作，不记录完整状态快照
- **实现**: 引入 sys_organization_audit 表，记录操作类型、操作人、关键信息变更

**Q3: 数据权限缓存策略**
- **用户选择**: B - 登录时缓存
- **说明**: 用户登录时将主部门及所有子部门 ID 缓存到 Redis，组织架构变更时主动失效缓存
- **实现**: 缓存 key 格式 `user:dept:{user_id}`，存储部门 ID 集合，部门变更时删除相关用户缓存

---

## Clarifications

### Session 2025-01-25

- Q: deleted_at 字段类型需要调整吗？ → A: 是的，使用 DATETIME(3) 类型以确保 GORM 软删除正常工作（GORM 的 DeletedAt 需要 Time 类型，对应 MySQL 的 DATETIME(3) 毫秒精度）

---

## Assumptions

1. **数据迁移**: 组织架构初期数据由管理员通过接口创建或批量导入
2. **性能优化**: 祖先路径（ancestors）字段采用物化路径模式，以空间换时间，优化查询性能
3. **删除策略**: 采用逻辑删除，保留数据用于审计和恢复
4. **事务管理**: 移动部门操作需要事务保证原子性，更新本节点及所有子孙节点的 ancestors
5. **错误码范围**: 组织架构模块使用 200100 - 200150 区间定义业务错误码
6. **外键约束**: 数据库表不创建外键约束，通过应用层逻辑保证数据一致性
7. **用户部门关联**: 基于 sys_user_dept 关联表实现，一个用户有且仅有一条 is_primary=true 的记录
8. **缓存失效**: 组织架构变更（创建、删除、移动）时，系统自动失效受影响用户的数据权限缓存
9. **审计日志**: 仅记录关键操作的审计信息，不记录每次字段变更的完整历史

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-01-25 | - | 初始版本，基于需求文档创建完整规格说明 |
| 1.1 | 2025-01-25 | - | 根据用户澄清更新：支持主部门+辅助部门模式、操作审计日志、登录时缓存策略 |
| 1.2 | 2025-01-25 | - | 技术澄清：deleted_at 字段使用 DATETIME(3) 类型以确保 GORM 软删除正常工作 |
