# 菜单管理模块需求文档（后端）

> 基于前端 `菜单管理` 页面交互稿整理，输出后端可落地的功能与接口需求。  
> 文档范围：菜单树管理、详情查询、创建/编辑/复制、排序与移动、启用/隐藏、权限绑定、审计与巡检、统计 KPI。

---

## 1. 目标与范围

### 1.1 目标

- 维护平台菜单树结构，确保导航与权限映射一致。
- 支持按多维度筛选、搜索、排序，快速定位菜单项。
- 提供菜单详情与审计信息，支持风险提示与巡检。

### 1.2 不在范围（可选）

- 导入/导出（若现阶段未实现，可仅预留接口）
- 权限系统的完整设计（仅做绑定/查询/创建联动）

---

## 2. 角色与权限

- 角色：平台管理员、权限管理员、只读用户（具体角色与权限由系统统一控制）。
- 基本权限矩阵（建议）：
  - 只读：列表/详情/审计/统计
  - 管理：创建/编辑/复制/删除/移动/排序/启用/隐藏
  - 权限管理：绑定权限、创建权限

---

## 3. 数据模型（建议）

### 3.1 菜单表 `menus`

| 字段 | 类型 | 约束/说明 |
|---|---|---|
| id | string | 主键（UUID 或雪花ID） |
| name | string | 必填，1-128 字符 |
| code | string | 必填，1-128 字符，**全局唯一** |
| type | string | 必填：`directory/page/external/button`（按实际枚举） |
| group_id | string | 可选，菜单分组 |
| parent_id | string | 可选，根节点为空 |
| path | string | `page/directory` 使用，路由路径 |
| route_name | string | 可选 |
| component_key | string | 页面组件标识（如前端路由组件） |
| external_url | string | `external` 必填 |
| open_mode | string | `external` 必填：`new/iframe/same` |
| permission_key | string | 可选（未绑定时产生风险标记） |
| visible | bool | 必填 |
| enabled | bool | 必填 |
| order | int | 必填，同级排序 |
| show_in_nav | bool | 可选（若区分导航展示） |
| cacheable | bool | 可选（前端 keepAlive） |
| created_at | datetime | 系统字段 |
| created_by | string | 系统字段 |
| updated_at | datetime | 系统字段 |
| updated_by | string | 系统字段 |
| deleted_at | datetime | 软删除（可选） |

### 3.2 计算/派生字段

| 字段 | 说明 |
|---|---|
| children_count | 子节点数量 |
| risk_flags[] | 风险标记数组，如：`UNBOUND_PERMISSION`、`ROUTE_CONFLICT`、`ORDER_CONFLICT` |

### 3.3 审计表 `menu_audit_logs`（建议）

- 记录菜单创建、编辑、删除、移动、排序、启用/隐藏等操作。

---

## 4. 功能需求（后端能力）

### 4.1 菜单树查询（主列表）

- 支持树形结构返回（含层级关系、排序字段、风险标记）。
- 支持搜索与过滤：
  - 搜索：`name/code/path/permissionKey` 关键词
  - 过滤：`enabled`、`visible`、`permission_bind`、`type`、`group_id`
- **返回策略**：
  - 若使用树：返回匹配节点及其必要祖先（便于前端展开显示）。
  - 支持平铺返回（可选，用于导出或后台巡检）。

### 4.2 菜单详情查询

- 根据菜单 ID 返回完整详情。
- 返回审计摘要（最近一次操作人/时间）。
- 返回权限绑定状态、风险标记。

### 4.3 新建菜单

- 支持 `directory/page/external/button` 不同类型的字段联动校验。
- 支持**两种权限绑定模式**：
  1) 选择已有 `permission_key`
  2) 创建新权限（需与权限服务联动）
- 默认 `order`：插入同级末尾（除非显式传入）。

### 4.4 编辑菜单

- 允许修改基础字段、路由字段、权限绑定、展示控制字段。
- 若 `type` 发生变化，需要重新校验字段合法性。

### 4.5 复制菜单（可选）

- 复制基础字段（不含 ID），可由前端调整名称/编码后提交创建。
- 若复制子树需明确是否允许（建议默认仅复制单节点）。

### 4.6 删除菜单

删除前需返回影响面信息：

- 子菜单数量
- 绑定权限是否被角色使用（可选，若权限系统可查）

删除策略建议：

- 若存在子节点，默认拒绝删除；或允许级联删除（需要显式参数）
- 软删除优先（保留审计）

### 4.7 启用/禁用、显示/隐藏

- 支持单条切换（也可批量，若有需求）
- 启用/禁用与显示/隐藏互不影响

### 4.8 排序与移动

两种方式：

- **排序模式**：拖拽调整同级顺序
- **移动菜单**：选择新父级和同级位置

后端需保证：

- 同级 `order` 唯一且连续（或可稀疏但稳定）
- 不能形成循环父子关系
- 若分组存在，父子必须同组

### 4.9 巡检/风险校验（可选）

提供接口返回全量风险信息：

- `UNBOUND_PERMISSION`：未绑定权限
- `ROUTE_CONFLICT`：路由冲突（同 `path` / `route_name`）
- `ORDER_CONFLICT`：同级 `order` 冲突

### 4.10 KPI 统计

返回以下统计用于头部 KPI：

- 总菜单数
- 启用菜单数
- 隐藏菜单数
- 未绑定权限菜单数（高风险）

### 4.11 审计日志

- 查询菜单的操作日志（分页、筛选：时间/操作者/字段）

---

## 5. 字段校验与业务规则

### 5.1 字段必填规则（按类型）

| 类型 | 必填字段 |
|---|---|
| directory | name, code, type |
| page | name, code, type, path, component_key（如需） |
| external | name, code, type, external_url, open_mode |
| button | name, code, type |

> 注：`permission_key` 允许为空，但将产生 `UNBOUND_PERMISSION` 风险标记。

### 5.2 唯一性与冲突检测

- `code` 全局唯一
- `path` / `route_name` 建议全局唯一（若不唯一需返回冲突信息）
- 同级 `order` 不可重复

### 5.3 结构约束

- 不允许父子循环
- 父节点不能为自身或子孙节点
- 若启用分组：父子必须同 `group_id`

---

## 6. API 需求（建议接口）

> 以下为建议路径，具体以现有 API 规范调整。

### 6.1 菜单树查询

`GET /api/system/menus/tree`

**Query**

- `keyword`：模糊搜索（name/code/path/permissionKey）
- `enabled`：true/false
- `visible`：true/false
- `permission_bind`：`bound/unbound`
- `type`：枚举
- `group_id`

**Response**

- 返回树结构数组，节点包含 `children`、`children_count`、`risk_flags[]`、`updated_at/updated_by`

### 6.2 菜单详情

`GET /api/system/menus/{id}`

### 6.3 新建菜单

`POST /api/system/menus`

### 6.4 更新菜单

`PUT /api/system/menus/{id}`

### 6.5 删除菜单

`DELETE /api/system/menus/{id}`

**Query**

- `cascade`（可选，默认 false）

### 6.6 启用/禁用、显示/隐藏

- `PATCH /api/system/menus/{id}/enabled`
- `PATCH /api/system/menus/{id}/visible`

### 6.7 排序/移动

- `PATCH /api/system/menus/{id}/move`：指定新父级与目标序号
- `PATCH /api/system/menus/reorder`：批量排序（同级）

### 6.8 巡检

`GET /api/system/menus/inspection`

### 6.9 KPI 统计

`GET /api/system/menus/stats`

### 6.10 审计日志

`GET /api/system/menus/{id}/audits`

---

## 7. 返回码与错误处理（示例）

- 400：参数校验失败（必填、格式、枚举）
- 404：菜单不存在
- 409：唯一性冲突（code/path/route_name/order）
- 422：业务规则不满足（删除有子节点、循环父子）
- 403：权限不足

---

## 8. 边界与并发处理

- 并发创建相同 `code`：仅首个成功，其余返回 409
- 排序并发冲突：采用乐观锁或 `updated_at` 校验
- 大树查询性能：支持缓存或按需返回（可选）

---

## 9. 待确认项

- 权限系统接口：`permission_key` 是否必须存在？是否允许后端创建？
- `group_id` 是否已定义实体与字典？
- 删除策略：是否允许级联删除？
- 路由冲突判定规则：`path` 与 `route_name` 是否需要全局唯一？
- KPI 是否需要按过滤条件动态统计？


## 10. 错误码
按照 200130-200150的去命名