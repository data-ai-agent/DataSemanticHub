# 权限模板功能需求文档（后端）

> 来源：前端《角色与权限管理》中的“权限模板”页与角色创建流程。  
> 目标：后端提供权限模板的生命周期管理、策略矩阵存储与应用能力。

---

## 1. 目标与范围

### 1.1 目标

- 维护“岗位/角色标准权限模板”，提升角色创建效率。
- 提供模板的创建、编辑、发布、停用、复制、删除能力。
- 支持从模板创建角色或在新建角色时选择模板预填权限策略。

### 1.2 非目标（可后续）

- 模板版本管理与差异应用（P2 规划）
- 模板导入/导出（可选）

---

## 2. 功能概览

### 2.1 页面能力（前端映射）

- 模板列表：搜索、筛选（状态、适用范围）、排序（更新时间）
- 模板详情：基本信息 + 策略矩阵 + 高级权限点
- 业务动作：新建、编辑、发布、停用、复制、删除
- 使用情况（可选）：被多少角色引用、最近应用时间
- 一键从模板创建角色（可选）

---

## 3. 数据模型（建议）

### 3.1 模板表 `permission_templates`

| 字段 | 类型 | 说明 |
|---|---|---|
| id | string | 主键 |
| name | string | 必填，1-128 |
| code | string | 必填，全局唯一 |
| desc | string | 可选 |
| status | string | `draft/published/disabled` |
| scope_suggestion | string | 推荐范围（可选：全平台/组织/域等） |
| policy_matrix | json | 模块 × 动作勾选 |
| advanced_perms | json | 高级权限点（可选） |
| created_by | string | |
| created_at | datetime | |
| updated_by | string | |
| updated_at | datetime | |
| deleted_at | datetime | 软删除（可选） |

### 3.2 使用统计（可选）

| 字段 | 说明 |
|---|---|
| used_by_role_count | 被引用角色数 |
| last_applied_at | 最近应用时间 |

### 3.3 审计日志（建议）

记录模板的创建、编辑、发布、停用、删除、复制等操作。

---

## 4. 业务规则与校验

### 4.1 字段校验

- `name`、`code` 必填
- `code` 全局唯一
- `policy_matrix` 必填

### 4.2 状态流转

- `draft` → `published`
- `published` → `disabled`
- `disabled` → `published`（可选，若允许重新启用）

### 4.3 编辑与发布规则（建议）

- 仅 `draft` 允许编辑
- `published` 模板不可直接编辑，需 **复制为新模板** 再编辑
- `disabled` 模板不可用于角色创建

> 若后续引入模板版本，可改为：编辑 published 生成新 draft 版本并发布。

---

## 5. 后端功能需求

### 5.1 模板列表查询

支持：
- 关键字搜索（name/code）
- 状态筛选（draft/published/disabled）
- 适用范围筛选（scope_suggestion）
- 返回：模板摘要 + 使用统计（可选）

### 5.2 模板详情查询

- 返回完整 `policy_matrix` 与 `advanced_perms`
- 返回使用统计（如被引用角色数）

### 5.3 新建模板

- 默认状态 `draft`
- 支持先保存草稿

### 5.4 编辑模板

- 仅草稿状态可编辑
- 支持调整：基本信息、策略矩阵、高级权限点

### 5.5 发布模板

- 将 `draft` 切换为 `published`
- 发布时校验：策略矩阵为空时禁止发布

### 5.6 停用模板

- 已发布模板可停用
- 停用后不可用于新建角色

### 5.7 复制模板

- 复制基础字段（name/code 需调整）
- 复制 `policy_matrix` 与 `advanced_perms`
- 新模板状态为 `draft`

### 5.8 删除模板

删除前返回影响面：
- 被引用角色数（若 > 0 可拒绝或提示确认）

---

## 6. 与角色创建的联动

### 6.1 角色创建选择模板

- 新建角色接口支持 `template_id`（可选）
- 选择模板后，后端返回/预填该模板的权限策略

### 6.2 从模板一键创建角色（可选）

- 基于模板快速生成角色草稿（可仅生成默认策略）
- 返回角色 ID 与默认策略

---

## 7. API 需求（建议）

> 按现有 API 规范命名为准。

### 7.1 模板列表

`GET /api/system/permission-templates`

Query：
- `keyword`
- `status`
- `scope_suggestion`
- `page/size`

### 7.2 模板详情

`GET /api/system/permission-templates/{id}`

### 7.3 新建模板

`POST /api/system/permission-templates`

### 7.4 编辑模板

`PUT /api/system/permission-templates/{id}`

### 7.5 发布模板

`POST /api/system/permission-templates/{id}/publish`

### 7.6 停用模板

`POST /api/system/permission-templates/{id}/disable`

### 7.7 复制模板

`POST /api/system/permission-templates/{id}/clone`

### 7.8 删除模板

`DELETE /api/system/permission-templates/{id}`

### 7.9 模板使用情况（可选）

`GET /api/system/permission-templates/{id}/usage`

---

## 8. 错误码与异常处理（示例）

- 400：参数校验失败
- 404：模板不存在
- 409：`code` 冲突
- 422：状态不允许（如发布非 draft）
- 403：权限不足

---

## 9. 待确认项

- `scope_suggestion` 是否有固定枚举？是否需字典表？
- `policy_matrix` 与高级权限点的数据结构定义（与权限系统保持一致）
- 是否允许禁用模板重新启用？
- 模板被角色引用时的删除策略（禁止/允许强制删除）
- 是否需要模板版本化（P2）与发布审批？

## 10. 错误码
按照 200130-200150的去命名